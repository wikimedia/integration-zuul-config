- publisher:
    name: archive-tox-logs
    publishers:
     - archive:
         artifacts: '**/.tox/*/log/*.log,**/.tox/log/*'

- publisher:
    name: archive-tox-logs-allow-empty
    publishers:
     - archive:
         artifacts: '**/.tox/*/log/*.log,**/.tox/log/*'
         allow-empty: true

- job-template:
    name: '{name}-tox-{toxenv}-jessie'
    node: ci-jessie-wikimedia
    defaults: use-remoteonly-zuul
    concurrent: true
    triggers:
     - zuul
    builders:
     - castor-load
     - run-tox:
         venv: '{toxenv}'
    publishers:
     - archive-log-dir
     - castor-save

# Same for Jessie
- job-template:
    name: 'tox-{toxenv}-jessie'
    node: ci-jessie-wikimedia
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - castor-load
     - run-tox:
         venv: '{toxenv}'
    publishers:
     - archive-log-dir
     - castor-save

- job-template: &job_tox-jessie
    name: 'tox-jessie'
    node: ci-jessie-wikimedia
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - castor-load
     - tox-all-envs
    publishers:
     - archive-log-dir
     - archive-tox-logs
     - castor-save

- job-template:
    !!merge : *job_tox-jessie
    name: '{name}-tox-jessie'
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul

- job-template: &job_tox-docker
    name: 'tox-docker'
    node: DebianJessieDocker
    concurrent: true
    docker_image_var: 'wmfreleng/tox:v2017.11.10.21.35'
    triggers:
        - zuul
    builders:
        - docker-castor-load
        - docker-log-dir
        - docker-run-with-log-and-workspace-cache:
            image: '{obj:docker_image_var}'
            logdir: '/log'
    wrappers:
        - timeout:
            timeout: '{obj:build_timeout|3}'  # minutes
        - timestamps
        - ansicolor
    publishers:
        - archive-log-dir
        - castor-save-workspace-cache

- job-template:
    !!merge : *job_tox-docker
    name: '{name}-tox-docker'
    triggers:
        - zuul

- job-template:
    !!merge : *job_tox-docker
    name: '{name}-tox-{toxenv}-docker'
    triggers:
        - zuul
    builders:
        - docker-castor-load
        - docker-log-dir
        - docker-run-with-log-and-workspace-cache:
            image: 'wmfreleng/tox:v2017.11.10.21.35'
            logdir: '/log'
            run_args: ' -e "{toxenv}"'

# Call tox env 'docvenv' (default: 'doc' to generate documentation in labs and
# publish to doc.wikimedia.org using an intermediate rsync repository in labs.
# Intended for changes being merged, eg in 'postmerge'
- job-template:
    name: '{name}-tox-publish'
    node: ci-jessie-wikimedia
    defaults: use-remoteonly-zuul
    triggers:
     - zuul
    builders:
     - castor-load
     - run-tox:
         venv: '{obj:docenv|doc}'
     - doc-publish:
        docsrc: '{docsrc}'
        docdest: '{docdest}'

    publishers:
     - castor-save
     - archive-log-dir

# Same but for ref-update, eg in 'publish'
- job-template:
    name: '{name}-tox-tag-publish'
    node: ci-jessie-wikimedia
    defaults: use-remoteonly-zuul
    triggers:
     - zuul-post
    builders:
    # No cache restore/save (castor) for tags
     - run-tox:
         venv: '{obj:docenv|doc}'
     - doc-publish:
        docsrc: '{docsrc}'
        docdest: '{docdest}'
    publishers:
     - archive-log-dir

# Publish jobs for merged changes and tags
- job-group:
    name: 'tox-publish'
    jobs:
        - '{name}-tox-publish'
        - '{name}-tox-tag-publish'

- job:
    name: 'tox-py27-coverage-publish'
    node: ci-jessie-wikimedia
    defaults: use-remoteonly-zuul
    concurrent: false
    triggers:
     - zuul
    builders:
     - castor-load
     # Most is copied from our 'run-tox' macro
     - shell: |
         rm -fR coverage log
         mkdir -p log
         set -o pipefail
         TOX_TESTENV_PASSENV=PY_COLORS PY_COLORS=1 tox -e py27 -- --cover-html --cover-html-dir=coverage/ | tee "log/tox-coverage.log"
         set +o pipefail
     - cover-publish:
        src: 'coverage'
        dest: '$DOC_PROJECT'
    publishers:
        - castor-save
        - archive-log-dir

- project:
    name: common-tox-jobs
    jobs:
     - 'tox-docker'
     - 'tox-jessie'
     - 'tox-{toxenv}-jessie':
         toxenv:
             - doc

- job:
    name: 'commit-message-validator'
    node: contintLabsSlave && DebianJessie
    defaults: use-remoteonly-zuul
    concurrent: true
    triggers:
     - zuul
    builders:
     - shell: |
        . /srv/deployment/integration/slave-scripts/bin/run-commit-message-validator

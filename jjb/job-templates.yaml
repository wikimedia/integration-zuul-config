- job-template:
    name: '{name}-jsduck-docker'
    node: DebianJessieDocker
    concurrent: true
    triggers:
     - zuul
    builders:
     - docker-log-dir
     - docker-src-dir
     - docker-ci-src-setup-simple
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/jsduck:0.1.0
         logdir: '/log'
    archive:
     - archive-log-allow-empty

- job-template: &job_template_maven-java8-docker
    name: '{name}-maven-java8-docker'
    # m4executor label are slaves with 4GBytes memory. Lot of our Java
    # repositories require extra memory such as mjolnir or refinery.
    node: DebianJessieDocker && m4executor
    docker_image_var: docker-registry.wikimedia.org/releng/java8:0.3.2
    triggers:
        - zuul
    maven_args: 'clean verify'
    builders:
        - docker-castor-load
        - docker-log-dir
        - docker-run-with-log-and-workspace-cache:
            docker_run_options: '{obj:docker_run_options|}'
            image: '{obj:docker_image_var}'
            logdir: '/log'
            run_args: '{obj:maven_args}'
    publishers:
        - archive-log-allow-empty
        - castor-save-workspace-cache

# Convenience alias with name/project variables
- job-template:
    !!merge : *job_template_maven-java8-docker
    name: '{name}-{project}-maven-java8-docker'
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul

# Same as '{name}-maven-java8-docker' but src is bindmounted so we can later
# retrieve the site from /src/target/ and push it to doc.wikimedia.org
- job-template: &job_template_maven-java8-docker-site-publish
    name: '{name}-maven-java8-docker-site-publish'
    # m4executor label are slaves with 4GBytes memory. Lot of our Java
    # repositories require extra memory such as mjolnir or refinery.
    node: DebianJessieDocker && m4executor
    docker_image_var: docker-registry.wikimedia.org/releng/java8:0.3.2
    triggers:
        - zuul
    maven_args: '-DskipTests -Dmaven.test.skip=true clean install site site:stage'
    builders:
        - docker-castor-load
        - docker-log-dir
        - docker-src-dir
        - docker-run-with-log-cache-src:
            image: '{obj:docker_image_var}'
            logdir: '/log'
            run_args: '{obj:maven_args}'
    publishers:
        - postbuildscript:
              builders:
                  - doc-publish:
                      docsrc: 'src/target/staging'
                      docdest: '{name}'
        - archive-log-allow-empty
        - castor-save-workspace-cache

- job-template:
    name: '{name}-{project}-maven-java8-docker-site-publish'
    maven_args: 'clean install site site:stage'
    !!merge : *job_template_maven-java8-docker-site-publish
    triggers:
        - zuul
    publishers:
        - postbuildscript:
              builders:
                  - doc-publish:
                      docsrc: 'src/target/staging'
                      docdest: '{name}-{project}'
        - archive-log-allow-empty
        - castor-save-workspace-cache

- job-template: &job_npm-node-6-docker
    name: 'npm-node-6-docker'
    node: DebianJessieDocker
    concurrent: true
    docker_image_var: 'docker-registry.wikimedia.org/releng/npm-test:0.3.0'
    docker_run_options_var: ''
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-src-dir
     - docker-log-dir
     - docker-ci-src-setup-simple
     - docker-run-with-log-cache-src:
        docker_run_options: '{obj:docker_run_options_var}'
        image: '{obj:docker_image_var}'
        logdir: '/log'
    publishers:
     - archive-log-allow-empty
     - castor-save-workspace-cache

- project:
    name: 'generic-npm-job'
    jobs:
        - 'npm-node-6-docker'

- job-template:
    !!merge : *job_npm-node-6-docker
    name: '{name}-npm-node-6-docker'
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul

# Variant for MediaWiki services /deploy repos
# We only need to install devDependencies, and use a different entry point
- job-template:
    !!merge : *job_npm-node-6-docker
    name: '{name}-deploy-npm-node-6-docker'
    docker_image_var: 'docker-registry.wikimedia.org/releng/npm-test:0.4.0'
    docker_run_options_var: '--entrypoint=/run-oid.sh'
    triggers:
     - zuul

- job-template: &job_npm-run-script-node-6-docker
    !!merge : *job_npm-node-6-docker
    name: '{name}-npm-run-{script}-node-6-docker'
    docker_run_options_var: ''
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-src-dir
     - docker-log-dir
     - docker-ci-src-setup-simple
     - docker-run-with-log-cache-src:
        docker_run_options: '{obj:docker_run_options_var}'
        image: '{obj:docker_image_var}'
        logdir: '/log'
        run_args: '{script}'

# Variant for MediaWiki services /deploy repos
- job-template:
    !!merge : *job_npm-run-script-node-6-docker
    name: '{name}-deploy-npm-run-{script}-node-6-docker'
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul
    docker_image_var: 'docker-registry.wikimedia.org/releng/npm-test:0.4.0'
    docker_run_options_var: '--entrypoint=/run-oid.sh'

- job-template:
    name: 'mediawiki-core-npm-node-6-docker'
    !!merge : *job_npm-node-6-docker

    # Instruct wmfreleng/ci-src-setup-simple to skip processing submodules.
    # mediawiki/core wmf branches have a lot of submodules and we dont need to
    # run npm tests for them.
    parameters:
        - string:
            name: GIT_NO_SUBMODULES
            default: "1"

    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul

- job-template:
    !!merge : *job_npm-node-6-docker
    name: '{name}-npm-browser-node-6-docker'
    docker_image_var: 'docker-registry.wikimedia.org/releng/npm-browser-test:0.1.2'
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul

# A very specific job for MobileFrontend which uses a JavaScript test suite
# which requires mediawiki/core.
- job-template:
    name: 'mwext-MobileFrontend-npm-run-lint-modules-docker'
    node: DebianJessieDocker
    concurrent: true
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-log-dir
     - docker-zuul-cloner:
         projects: >
             mediawiki/core
             mediawiki/extensions/MobileFrontend
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/npm-php:0.1.0
         docker_run_options: '--workdir /src/extensions/MobileFrontend'
         run_args: 'install'
         logdir: '/log'
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/npm-php:0.1.0
         docker_run_options: '--workdir /src/extensions/MobileFrontend'
         run_args: 'run-script lint:modules'
         logdir: '/log'
    publishers:
     - archive-log-allow-empty
     - castor-save-workspace-cache

- job-template:
    name: '{phpflavor}lint'
    node: contintLabsSlave && DebianJessie
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - phplint

- project:
    name: 'php-all-lint'
    phpflavor:
        - 'php55'
        - 'php56'
    jobs:
        - '{phpflavor}lint'

- job-template:
    name: '{name}-{phpflavor}lint'
    node: contintLabsSlave && DebianJessie
    defaults: use-remote-zuul-no-submodules
    concurrent: true
    properties:
     - build-discarder:
         days-to-keep: 15
    triggers:
     - zuul
    builders:
     - phplint

# Verify whether there is any leading tabs in files matching 'fileselector'.
#
# 'fileselector': the parameter is passed to grep --include= option and is
# comma separated.
#
- job-template:
    name: '{name}-tabs'
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    node: contintLabsSlave && DebianJessie
    triggers:
     - zuul
    builders:
     - shell: |
         #!/bin/bash -e
         echo "Looking for tabulations in files matching: {fileselector}"
         set -x
         (grep --recursive -P '^\t' --exclude-dir='.git' --include='{fileselector}' .) && HAS_TAB=1 || HAS_TAB=0
         exit $HAS_TAB

# Generic job-templates

- job:
    name: 'erblint-HEAD'
    node: hasSlaveScripts && UbuntuPrecise
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - erblint-HEAD

# Non-generic version of "jshint" and "jsonlint"
# below.
- job-template:
    name: '{name}-jslint'
    node: hasSlaveScripts && UbuntuPrecise
    defaults: use-remote-zuul-no-submodules
    concurrent: true
    triggers:
     - zuul
    builders:
     - jshint
     - jsonlint

- job:
    name: 'jshint'
    node: hasSlaveScripts && UbuntuPrecise
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - jshint

- job:
    name: 'jsonlint'
    node: hasSlaveScripts && UbuntuPrecise
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - jsonlint

- job:
    name: 'jsduck'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - jsduck

# Deprecated non-generic jsduck job. You should use the above 'jsduck' job.
# For repos that need to preserve workspace or have submodules, this is
# used as workaround.
- job-template:
    name: '{name}-jsduck'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    concurrent: true
    triggers:
     - zuul
    builders:
     - jsduck

# Deprecated non-generic npm job. Use the
# generic 'npm' job below.
- job-template:
    name: '{name}-npm'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    concurrent: true
    triggers:
     - zuul
    builders:
     - npm
    publishers:
     - global-teardown

- job:
    name: 'npm'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - npm
    publishers:
     - global-teardown

- job-template:
    name: '{name}-{repository}-npm'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    concurrent: true
    triggers:
     - zuul
    builders:
     - npm-oid:
         repository: '{repository}'
    publishers:
     - global-teardown

# Run composer update and composer test
# Intended for libraries that are published as composer packages
- job-template:
    name: 'php-composer-test-{phpflavor}'
    node: 'contintLabsSlave && (UbuntuPrecise && phpflavor-zend && phpflavor-{phpflavor}) || (UbuntuTrusty && phpflavor-hhvm && phpflavor-{phpflavor})'
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - composer-validate-package
     - composer-update
     - shell: |
         /srv/deployment/integration/composer/vendor/bin/composer test

- project:
    name: 'php-composer-test-flavored'
    jobs:
     - 'php-composer-test-{phpflavor}':
        phpflavor:
            - hhvm
            - zend

# Checks the committed composer.lock file against the database at
# https://github.com/FriendsOfPHP/security-advisories and the API
# provided by https://security.sensiolabs.org to see if any of them
# have reported security issues. See also T74193.
- job-template:
    name: '{name}-composer-security'
    node: contintLabsSlave && UbuntuPrecise
    concurrent: true
    scm:
      - git:
          url: 'https://gerrit.wikimedia.org/r/{repository}'
          branches:
            - master
          wipe-workspace: false  # keep the workspace...
          clean: true            # ... and use git clean instead
          prune: true            # prune remote obsoletes branches
          recursive-submodules: false
    builders:
     - shell: |
         curl -i -H "Accept: text/plain" https://security.sensiolabs.org/check_lock -F lock=@composer.lock -o sensiolabs.check
         cat sensiolabs.check && grep -F "X-Alerts: 0" sensiolabs.check
    publishers:
     - email:
        recipients: '{notify}'
    triggers:
        - timed: "H 20 * * *"

- job-template:
    name: '{name}-puppetlint-lenient'
    node: contintLabsSlave && UbuntuPrecise
    defaults: use-remote-zuul-no-submodules
    concurrent: true
    triggers:
     - zuul
    builders:
     - puppet-lint-lenient
    publishers:
     - puppet-lint

- job-template:
    name: '{name}-puppetlint-strict'
    node: contintLabsSlave && UbuntuPrecise
    defaults: use-remote-zuul-no-submodules
    concurrent: true
    triggers:
     - zuul
    builders:
     - puppet-lint-strict
    publishers:
     - puppet-lint

- job:
    name: 'pplint-HEAD'
    node: hasSlaveScripts && UbuntuPrecise
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - pplint-HEAD

- job:
    name: 'perllint'
    node: hasSlaveScripts && UbuntuPrecise
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - perllint

- job:
    name: 'phplint'
    node: contintLabsSlave && UbuntuPrecise
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - phplint

# Deprecated non-generic phplint job. You should
# use the above 'phplint' job. Due to a performance issue
# with Git on Ubuntu Precise (details on T92042), this is
# kept around for large repositories that need to have their
# own workspace.
- job-template:
    name: '{name}-phplint'
    node: contintLabsSlave && UbuntuPrecise
    defaults: use-remote-zuul-no-submodules
    concurrent: true
    triggers:
     - zuul
    builders:
     - phplint


# PHP CodeSniffer on everything under the workspace
- job-template:
    name: '{name}-phpcs'
    node: hasSlaveScripts && UbuntuPrecise
    defaults: use-remote-zuul-no-submodules
    concurrent: true
    triggers:
     - zuul
    builders:
     - phpcs
    publishers:
     - checkstyle-xml
     - phpcs

# PHP CodeSniffer on changed files
- job-template:
    name: '{name}-phpcs-HEAD'
    node: hasSlaveScripts && UbuntuPrecise
    defaults: use-remote-zuul-no-submodules
    concurrent: true
    triggers:
     - zuul
    builders:
     - phpcs-HEAD
    publishers:
     - checkstyle-xml
     - phpcs

- job:
    name: 'phpunit'
    node: hasSlaveScripts && UbuntuPrecise
    defaults: use-remote-zuul-shallow-clone
    triggers:
     - zuul
    builders:
     - phpunit-junit
    publishers:
     - phpunit-junit
     - archive-log-dir

- job-template:
    name: '{name}-puppet-validate'
    defaults: use-remote-zuul-no-submodules
    node: contintLabsSlave
    concurrent: true
    triggers:
     - zuul
    builders:
     - puppet-validate

# Deprecated non-generic job. Should use the
# generic "ruby1.9.3lint" job below.
- job-template:
    name: '{name}-ruby1.9.3lint'
    defaults: use-remote-zuul-no-submodules
    concurrent: true
    triggers:
     - zuul
    builders:
     - ruby-lint:
        interpreter: 'ruby1.9.3'

- job:
    name: 'ruby1.9.3lint'
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - ruby-lint:
        interpreter: 'ruby1.9.3'

- job:
    name: 'ruby2.0lint'
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    node: contintLabsSlave && UbuntuTrusty
    triggers:
     - zuul
    builders:
     - ruby-lint:
        interpreter: 'ruby2.0'

# Verifiy whether there is any leading tabs in files matching 'fileselector'.
#
# 'fileselector': the parameter is passed to grep --include= option and is
# comma separated.
#
- job-template:
    name: '{name}-tabs'
    defaults: use-remote-zuul-no-submodules
    concurrent: true
    triggers:
     - zuul
    builders:
     - shell: |
         #!/bin/bash -e
         echo "Looking for tabulations in files matching: {fileselector}"
         set -x
         (grep --recursive -P '^\t' --exclude-dir='.git' --include='{fileselector}' .) && HAS_TAB=1 || HAS_TAB=0
         exit $HAS_TAB


- job:
    name: 'yamllint'
    defaults: use-remote-zuul-shallow-clone
    node: contintLabsSlave && hasSlaveScripts && UbuntuPrecise
    concurrent: true
    triggers:
     - zuul
    builders:
     - yaml-lint

# Java checktyle for maven projects
- job-template:
    name: '{name}-maven-checkstyle'
    node: contintLabsSlave && UbuntuPrecise # Maven download the whole internet
    concurrent: true
    project-type: maven
    triggers:
      - zuul
    scm:
      - git-remote-zuul-no-submodules
    wrappers:
      - timeout:
          timeout: 5  # minutes
          fail: true
      - timestamps
      - ansicolor
    maven:
      goals: "checkstyle:checkstyle-aggregate"
      maven-opts: "-Dcheckstyle.config.location=$WORKSPACE/checkstyle.xml -Dencoding=utf-8"
    publishers:
      - checkstyle:
          pattern: "**/checkstyle-result.xml"
          canRunOnFailed: true
          healthy: 0
          unHealthy: 100
          healthThreshold: 'high'
          thresholds:
            unstable:
              totalHigh: 10
            failed:
              totalHigh: 1

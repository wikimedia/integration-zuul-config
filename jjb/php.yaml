# Generic Jobs related to PHP

# Job for libraries that are published as composer packages.
# Includes full validation that packagist.org requires.
- job:
    name: composer-package-validate
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: true

    triggers:
     - zuul
    builders:
     - composer-validate-package
    logrotate:
        daysToKeep: 15

# Job for anything with a composer.json, but *isn't* going to be
# published on packagist.org.
- job:
    name: composer-validate
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: true

    triggers:
     - zuul
    builders:
     - composer-validate:
        dir: '.'
    logrotate:
        daysToKeep: 15

# Generic job that runs "composer update" and "composer test"
- job-template:
    name: 'composer-{phpflavor}'
    node: 'contintLabsSlave && phpflavor-{phpflavor}'
    defaults: use-remote-zuul-shallow-clone
    concurrent: true

    triggers:
     - zuul
    builders:
     - composer-validate:
        dir: '.'
     - composer-update:
        dir: '.'
     - composer-test
    logrotate:
        daysToKeep: 15

- project:
    name: 'composer-flavored'
    jobs:
     - 'composer-{phpflavor}':
        phpflavor:
            - hhvm
            - php53
            - php55

# Same as 'composer-{phpflavor}'. Runs "composer update" and "composer test"
# but on disposable instances maintained by Nodepool.
- job-template:
    name: 'composer-{phpflavor}-{image}'
    node: ci-{image}-wikimedia
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    logrotate:
        daysToKeep: 15
    properties:
     - zeromq-event
    triggers:
     - zuul
    builders:
     - assert-phpflavor:
         phpflavor: '{phpflavor}'
     - castor-load
     - composer-validate:
        dir: '.'
     - composer-update:
        dir: '.'
     - composer-test
    publishers:
     - castor-save

- project:
    name: 'composer-flavored-on-nodepool'
    jobs:
     - 'composer-{phpflavor}-{image}':
         phpflavor:
             # Zend 55 is solely on Trusty
             - php55:
                 image: trusty
             # Wikimedia runs HHVM on Trusty and will move to Jessie
             - hhvm:
                 image: trusty
             - hhvm:
                 image: jessie

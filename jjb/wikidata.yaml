- builder:
    name: wd-mw-composer-install-ext
    builders:
        - shell: |
            composer=/srv/deployment/integration/composer/vendor/bin/composer
            cd "$WORKSPACE/src/" \
            && php -r '$c = json_decode( file_get_contents( "composer.json" ) );
                       $m="merge-plugin";
                       $c->extra->$m->include[] = "extensions/*/composer.json";
                       file_put_contents( "composer.json", json_encode( $c ) );' \
            && timeout 300 $composer update --prefer-source -vvv

- builder:
    name: wd-wikibase-apply-settings
    builders:
     - shell: "$WORKSPACE/src/extensions/Wikibase/build/jenkins/mw-apply-wb-settings.sh -r {repoorclient} -e {experimental} -b false"

- builder:
    name: wd-build-apply-settings
    builders:
     - shell: "$WORKSPACE/src/extensions/Wikidata/extensions/Wikibase/build/jenkins/mw-apply-wb-settings.sh -r {repoorclient} -e {experimental} -b true"

- builder:
    name: wd-runtests
    builders:
        - shell: |
            cd "$WORKSPACE/src/tests/phpunit"
            php phpunit.php \
               --log-junit "$WORKSPACE/log/junit-wikidata.xml" \
               --with-phpunitdir /srv/deployment/integration/phpunit/vendor/phpunit/phpunit \
               {params}

- job-template:
    name: 'mwext-{ext-name}-{kind}-tests-{dbflavor}-{phpflavor}'
    node: 'contintLabsSlave && ((UbuntuPrecise && phpflavor-zend && phpflavor-{phpflavor}) || (UbuntuTrusty && phpflavor-hhvm && phpflavor-{phpflavor}))'
    concurrent: true
    triggers:
     - zuul
    builders:
     - assert-phpflavor:
         phpflavor: '{phpflavor}'
     - hhvm-clear-hhbc
     - zuul-cloner-extdeps:
         ext-name: '{ext-name}'
         dependencies: '{dependencies}'
     - wd-mw-composer-install-ext
     - 'mw-install-{dbflavor}'
     - shell: "cp deps.txt src/extensions_load.txt"
     - wd-wikibase-apply-settings:
          repoorclient: '{repoorclient}'
          experimental: 'true'
     - mw-apply-settings
     - mw-run-update-script
     - wd-runtests:
          params: '{phpunit-params}'
    publishers:
     - archive-log-dir
     - junit:
        results: 'log/junit*.xml'
     - 'mw-teardown-{dbflavor}'

- job-template:
    name: 'mwext-{ext-name}-qunit'
    node: contintLabsSlave && UbuntuTrusty
    concurrent: true
    triggers:
     - zuul
    builders:
     - zuul-cloner-extdeps:
         ext-name: '{ext-name}'
         dependencies: '{dependencies}'
     - wd-mw-composer-install-ext
     - mw-install-sqlite
     - shell: "cp deps.txt src/extensions_load.txt"
     - wd-wikibase-apply-settings:
          repoorclient: 'repo' # qunit tests are in lib so this can be either..
          experimental: 'true'
     - mw-apply-settings
     - mw-run-update-script
     - qunit-karma
    publishers:
     - archive-log-dir
     - qunit-cleanup
     - mw-teardown

- job-template:
    name: 'mwext-Wikidata-{kind}-tests'
    node: contintLabsSlave && UbuntuPrecise
    triggers:
     - zuul
    builders:
     - zuul-cloner-extdeps:
         ext-name: 'Wikidata'
         dependencies: '{dependencies}'
     - wd-build-apply-settings:
          repoorclient: '{repoorclient}'
          experimental: '{experimental}'
     - mw-install-sqlite
     - shell: "cp deps.txt src/extensions_load.txt"
     - mw-apply-settings
     - mw-run-update-script
     - wd-runtests:
          params: '{phpunit-params}'
    publishers:
     - archive-log-dir
     - junit:
        results: 'log/junit*.xml'
     - mw-teardown

- job-template:
    name: 'mwext-Wikidata-qunit'
    node: contintLabsSlave && UbuntuPrecise
    concurrent: true
    triggers:
     - zuul
    builders:
     - zuul-cloner-extdeps:
         ext-name: 'Wikidata'
         dependencies: '{dependencies}'
     - wd-build-apply-settings:
          repoorclient: 'repo' # qunit tests are in lib so this can be either..
          experimental: 'true'
     - mw-install-sqlite
     - shell: "cp deps.txt src/extensions_load.txt"
     - mw-apply-settings
     - mw-run-update-script
     - qunit-karma
    publishers:
     - archive-log-dir
     - qunit-cleanup
     - mw-teardown

# This is a modified version of '{name}-{ext-name}-qunit'.
# It runs "composer update" before the qunit tests.
- job:
    name: 'mwext-WikibaseJavaScriptApi-qunit'
    node: contintLabsSlave && UbuntuTrusty
    concurrent: true
    triggers:
     - zuul
    builders:
     - prepare-mediawiki-zuul-project
     - wd-mw-composer-install-ext
     - qunit-karma
    publishers:
     - qunit-cleanup
     - mw-teardown-mysql
     - archive-log-dir

- project:
    name: wikidata
    # By default we do not need any other extensions:
    dependencies: ""

    wrappers:
      - timeout:
          timeout: 30
          fail: true
      - timestamps
      - ansicolor

    jobs:

     - '{name}-{ext-name}-npm':
        name: 'mwext'
        ext-name: 'Wikibase'

     - 'mwext-{ext-name}-{kind}-tests-{dbflavor}-{phpflavor}':
        ext-name: 'Wikibase'
        kind: repo
        repoorclient: 'repo'
        dependencies: 'cldr'
        dbflavor:
          - mysql
          - sqlite
        phpflavor:
          - zend
          - hhvm
        phpunit-params: '--group Wikibase,WikibaseAPI,Purtle'
     - 'mwext-{ext-name}-{kind}-tests-{dbflavor}-{phpflavor}':
        ext-name: 'Wikibase'
        kind: client
        repoorclient: 'client'
        dependencies: 'Scribunto,cldr'
        dbflavor:
          - mysql
          - sqlite
        phpflavor:
          - zend
          - hhvm
        phpunit-params: '--group Wikibase,WikibaseClient'

     - 'mwext-{ext-name}-qunit':
        ext-name: 'Wikibase'

     - 'mwext-Wikidata-{kind}-tests':
        ext-name: 'Wikidata'
        kind: client
        repoorclient: 'client'
        experimental: 'true'
        dependencies: 'Scribunto,cldr'
        phpunit-params: '--group Wikibase,WikibaseClient'

     - 'mwext-Wikidata-{kind}-tests':
        ext-name: 'Wikidata'
        kind: client-nonexperimental
        repoorclient: 'client'
        experimental: 'false'
        dependencies: 'Scribunto,cldr'
        phpunit-params: '--group Wikibase,WikibaseClient'

     - 'mwext-Wikidata-{kind}-tests':
        ext-name: 'Wikidata'
        kind: repo
        repoorclient: 'repo'
        experimental: 'true'
        dependencies: 'Scribunto,cldr'
        phpunit-params: '--group Wikibase,PropertySuggester,Purtle'

     - 'mwext-Wikidata-{kind}-tests':
        ext-name: 'Wikidata'
        kind: repo-nonexperimental
        repoorclient: 'repo'
        experimental: 'false'
        dependencies: 'Scribunto,cldr'
        phpunit-params: '--group Wikibase,PropertySuggester,Purtle'

     - 'mwext-Wikidata-qunit':
        ext-name: 'Wikidata'


- job:
    name: wikidata-gremlin
    project-type: maven
    jdk: 'Ubuntu - OpenJdk 7'
    triggers:
     - zuul
    scm:
     - git-remote-zuul
    wrappers:
     - timeout:
         timeout: 60  # minutes
         fail: true
     - timestamps
     - ansicolor
    maven:
      goals: clean verify

- project:
    name: wikidata-gremlin
    jobs:
      - wikidata-gremlin

- job:
    name: wikidata-query-rdf
    node: 'contintLabsSlave'
    project-type: maven
    jdk: 'Ubuntu - OpenJdk 7'
    triggers:
     - zuul
    scm:
     - git-remote-zuul
    wrappers:
     - timeout:
         timeout: 60  # minutes
         fail: true
     - timestamps
     - ansicolor
    maven:
      goals: clean verify

- project:
    name: wikidata-query-rdf
    jobs:
      - wikidata-query-rdf

- project:
    name: WikidataQuality
    # By default we do not need any other extensions:
    dependencies: ""

    wrappers:
      - timeout:
          timeout: 30
          fail: true
      - timestamps
      - ansicolor

    jobs:

     - '{name}-{ext-name}-npm':
        name: 'mwext'
        ext-name: 'WikidataQuality'

     - 'mwext-{ext-name}-{kind}-tests-{dbflavor}-{phpflavor}':
        ext-name: 'WikidataQuality'
        kind: repo
        repoorclient: 'repo'
        dependencies: 'Wikibase'
        dbflavor:
          - mysql
          - sqlite
        phpflavor:
          - zend
          - hhvm
        phpunit-params: '--group WikidataQuality'

     - 'mwext-{ext-name}-qunit':
        ext-name: 'WikidataQuality'
        dependencies: 'Wikibase'

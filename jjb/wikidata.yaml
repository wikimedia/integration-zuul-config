- builder:
    name: wd-mw-composer-merged-install
    builders:
        - composer-local-create:
            deps: '../deps.txt'
        - composer-update:
            dir: '$WORKSPACE/src/'

- builder:
    name: wd-wikibase-apply-settings
    builders:
     - shell: "$WORKSPACE/src/extensions/Wikibase/build/jenkins/mw-apply-wb-settings.sh -r {repoorclient} -e {experimental} -b false"

- builder:
    name: wd-runtests
    builders:
        - shell: |
            . "/srv/deployment/integration/slave-scripts/bin/mw-set-env.sh"
            cd "$WORKSPACE/src/tests/phpunit"
            php -d zend.enable_gc=0 \
               phpunit.php \
               --log-junit "$WORKSPACE/log/junit-wikidata.xml" \
               {params}

- job-template:
    name: 'mwext-Wikibase-{kind}-tests-{dbflavor}-{phpflavor}-{image}'
    node: ci-{image}-wikimedia
    concurrent: true
    triggers:
     - zuul
    properties:
     - build-discarder:
         days-to-keep: 15
    builders:
     - assert-phpflavor:
         phpflavor: '{phpflavor}'
     - hhvm-clear-hhbc
     - castor-load
     - zuul-cloner-extdeps:
         dependencies: 'Wikibase,{dependencies}'
     - wd-mw-composer-merged-install
     - 'mw-install-{dbflavor}'
     - shell: "cp deps.txt src/extensions_load.txt"
     - wd-wikibase-apply-settings:
          repoorclient: '{repoorclient}'
          experimental: 'true'
     - mw-apply-settings
     - mw-run-update-script
     - wd-runtests:
          params: '{phpunit-params}'
    publishers:
     - castor-save
     - archive-log-dir
     - junit:
        results: 'log/junit*.xml'

- project:
    name: wikidata
    # By default we do not need any other extensions:
    dependencies: ""

    wrappers:
      - timeout:
          timeout: 30
          fail: true
      - timestamps
      - ansicolor

    jobs:
     # repo on Nodepool
     - 'mwext-Wikibase-{kind}-tests-{dbflavor}-{phpflavor}-{image}':
        kind: repo
        repoorclient: 'repo'
        dependencies: 'CirrusSearch,Elastica,GeoData,cldr'
        dbflavor:
          - sqlite
        phpflavor:
            - php55:
                image: jessie
            - hhvm:
                image: jessie
        phpunit-params: '--group Wikibase,WikibaseAPI,Purtle'

     # client on Nodepool
     - 'mwext-Wikibase-{kind}-tests-{dbflavor}-{phpflavor}-{image}':
        kind: client
        repoorclient: 'client'
        dependencies: 'Scribunto,Capiunto,cldr,Echo'
        dbflavor:
          - mysql
          - sqlite
        phpflavor:
           - php55:
               image: jessie
           - hhvm:
               image: jessie
        phpunit-params: '--group Wikibase,WikibaseClient'

- project:
    name: wikibase-javascript-api
    jobs:
        - '{name}-npm-browser-node-6-docker'

- project:
    name: wikibase-data-values-value-view
    jobs:
        - '{name}-npm-browser-node-6-docker'

- project:
    name: wikidata-query-gui
    jobs:
      - '{name}-npm-browser-node-6-docker'
      - 'wikidata-query-gui-build'

- project:
    name: wikidata-query-rdf
    jobs:
      - '{name}-maven-java8-docker':
          docker_image_var: docker-registry.wikimedia.org/releng/java8-wikidata-query-rdf:0.1.2
          goals: clean verify
      - '{name}-maven-java8-docker-site-publish':
          docker_image_var: docker-registry.wikimedia.org/releng/java8-wikidata-query-rdf:0.1.2
          # We need tests for org.wikidata.query.rdf.tool.Proxy - T190042
          maven_args: 'clean install site site:stage'

- project:
    name: wikiba.se
    jobs:
        - '{name}-composer-{phpflavor}-docker':
            # Runs on a Jessie ganeti host T171160
            phpflavor:
                - php56:
                    image: docker-registry.wikimedia.org/releng/composer-test-php56:0.1.0

- job:
    name: 'wikidata-query-gui-build'
    node: ci-jessie-wikimedia
    concurrent: false
    triggers:
     - zuul
    parameters:
        # Zuul parameters for Castor
        - string:
            name: 'ZUUL_BRANCH'
            default: 'master'
        - string:
            name: 'ZUUL_PROJECT'
            default: 'wikidata/query/gui'
        - string:
            name: 'ZUUL_PIPELINE'
            default: 'postmerge'
    scm:
        - git:
            url: https://gerrit.wikimedia.org/r/wikidata/query/gui
            branches:
                - master
            refspec: master
            wipe-workspace: false  # Not needed on Nodepool instances
            clean:
                after: true
            submodule:
                disable: false
    builders:
        - assert-node-version-6
        - castor-load
        - npm-install
        ## now create and publish a gerrit patch
        ## then publish the artifacts to castor?
        - shell: |
            GIT_AUTHOR_NAME=WDQSGuiBuilder
            GIT_COMMITTER_NAME=WDQSGuiBuilder
            GIT_AUTHOR_EMAIL=wdqs-gui-build@lists.wikimedia.org
            GIT_COMMITTER_EMAIL=wdqs-gui-build@lists.wikimedia.org

            # We do not know Gerrit SSH host fingerprint
            mkdir -p ~/.ssh
            echo -ne 'Host gerrit.wikimedia.org\n  StrictHostKeyChecking no\nUser wdqsguibuilder\n' >> ~/.ssh/config

            npm run deploy
    wrappers:
        - ansicolor
        - timeout:
            timeout: 15 # minutes
        - timestamps
        - ssh-agent-credentials:
            users:
                - 'wdqsguibuilder'
    publishers:
        - archive-log-allow-empty
        - castor-save


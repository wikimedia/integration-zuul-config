- job: &php-compile-php55
    name: 'php-compile-php55'
    node: contintLabsSlave && DebianJessie
    defaults: use-remoteonly-zuul
    triggers:
     - zuul
    builders:
     - shell: |
        /usr/bin/phpize5.5 --version
        /usr/bin/phpize5.5
        ./configure
        make
        REPORT_EXIT_STATUS=1 make test
    publishers:
     - archive-test-logs

- job:
    !!merge : *php-compile-php55
    name: 'php-compile-php55-jessie'
    node: ci-jessie-wikimedia
    triggers:
     - zuul

- job: &php-compile-php70
    name: 'php-compile-php70'
    node: contintLabsSlave && DebianJessie
    defaults: use-remoteonly-zuul
    triggers:
     - zuul
    builders:
     - shell: |
        /usr/bin/phpize7.0 --version
        /usr/bin/phpize7.0
        ./configure
        make
        REPORT_EXIT_STATUS=1 make test
    publishers:
     - archive-test-logs

- job-template:
    name: 'php-compile-{name}-docker'
    node: DebianJessieDocker
    triggers:
     - zuul
    builders:
     - docker-src-dir
     - docker-ci-src-setup-simple
     - shell: |
        #!/bin/bash -eu
        set -x
        exec docker run \
            --rm \
            --volume "$(pwd)"/src:/src \
            docker-registry.wikimedia.org/releng/{image} \
        # nothing else can be executed due to exec

- project:
    name: php70
    jobs:
      - 'php-compile-{name}-docker':
          image: php-compile:0.1.0

- project:
    name: php71
    jobs:
      - 'php-compile-{name}-docker':
          image: php71-compile:0.1.0

- project:
    name: php72
    jobs:
      - 'php-compile-{name}-docker':
          image: php72-compile:0.1.0


- job:
    !!merge : *php-compile-php70
    name: 'php-compile-php70-jessie'
    node: ci-jessie-wikimedia
    triggers:
     - zuul


- job: &php-compile-hhvm
    name: 'php-compile-hhvm'
    node: contintLabsSlave && DebianJessie
    defaults: use-remoteonly-zuul
    triggers:
     - zuul
    builders:
     - shell: |
         hhvm --version
         hphpize
         cmake .
         make
- job:
    !!merge : *php-compile-hhvm
    name: 'php-compile-hhvm-jessie'
    node: ci-jessie-wikimedia
    triggers:
     - zuul

- publisher:
    name: archive-test-logs
    publishers:
     - archive:
         artifacts: 'tests/*.log'
         allow-empty: true

# Version that runs the HHVM tests using a kind
# of hack.
- job: &php-compile-hhvm-test
    name: 'php-compile-hhvm-test'
    node: contintLabsSlave && DebianJessie
    defaults: use-remoteonly-zuul
    triggers:
     - zuul
    builders:
     - shell: |
         hhvm --version
         hphpize
         cmake .
         make
         phpize # Generate run-tests.php
         REPORT_EXIT_STATUS=1 ./hhvm-test.sh run-tests.php
    publishers:
     - archive-test-logs

- job:
    !!merge : *php-compile-hhvm-test
    name: php-compile-hhvm-test-jessie
    node: ci-jessie-wikimedia
    triggers:
     - zuul

# Sync files from a Jenkins slave in labs to a central rsync server from which
# another job (executing on gallium) can pull in the files and publish them
# on https://doc.wikimedia.org/.
#
# Uses $ZUUL_UUID as a unique identifier.
#
# Parameters:
#
# docsrc: Directory holding documentation files relative to workspace (without trailing slash)
# docdest: Directory under doc.wikimedia.org/
#
- builder:
    name: doc-publish
    docsrc: '{docsrc}'
    docdest: '{docdest}'
    builders:
     # rsync {docsrc} folder to integration-publisher.eqiad.wmflabs
     - shell: |
         if [ -z $ZUUL_UUID ]; then
            echo "Parameter \$ZUUL_UUID is missing!"
            echo "Can not rsync the documentation, aborting."
            exit 1
         fi
         rsync --recursive "{docsrc}/" "rsync://10.68.16.255/doc/$ZUUL_UUID"
     - trigger-builds:
       - project: doc-publish-sync
         block: true
         current-parameters: true  # Pass Zuul parameters
         predefined-parameters:
           WMF_CI_DOC_DEST={docdest}

# rsync a folder from integration-publisher.eqiad.wmflabs to the docroot
# of doc.wikimedia.org on gallium.
#
# Uses $ZUUL_UUID as a unique identifier.
- job:
    name: doc-publish-sync
    node: gallium # hosts doc.wikimedia.org

    parameters:
     - string:
         name: 'WMF_CI_DOC_DEST'
         description: 'Sub folder under /srv/org/wikimedia/doc/ to copy doc to'

    triggers:
     - zuul
    builders:
     - shell: |
         echo "Publishing $ZUUL_PROJECT from labs to prod"
         echo "Zuul UUID: $ZUUL_UUID"
         echo "..."
     - shell: |
         if [ "$WMF_CI_DOC_DEST" == "" ]; then
             echo "WMF_CI_DOC_DEST parameter is empty. Aborting"
             exit 1
         fi
         if [ -z $ZUUL_UUID ]; then
            echo "Parameter \$ZUUL_UUID is missing!"
            echo "Can not rsync the documentation, aborting."
            exit 1
         fi
         LOCAL_DEST="/srv/org/wikimedia/doc/$WMF_CI_DOC_DEST"
         mkdir -p "$LOCAL_DEST"
         rsync --recursive --delete-after "rsync://10.68.16.255/doc/$ZUUL_UUID"/ "$LOCAL_DEST"
     - shell: |
         set +x
         echo
         # Strip trailing slash from WMF_CI_DOC_DEST to avoid double slashes
         echo "Doc published under https://doc.wikimedia.org/${WMF_CI_DOC_DEST%/}/"
    publishers:
     - postbuildscript:
         builders:
          - shell: |
              if [ -z $ZUUL_UUID ]; then
                  # Avoid deleting all pending doc when ZUUL_UUID is not set
                  echo "\$ZUUL_UUID is not set, skipping removal from publishing instance."
                  exit 0
              fi
              echo "Removing directory from publishing instance..."
              rm -rf "$ZUUL_UUID"
              # The trick here is that the local side of the rsync does not
              # have the content at all at the time of sync. Rsync expands
              # `--include="$ZUUL_UUID/***"` to mean the directory and all of
              # it's contents followed by the exclusion of all files not
              # explicitly included. Without the three wildcards rsync will not
              # touch the named directory itself.
              #
              # -- Bryan "bd808" Davis
              rsync --delete --recursive --include="$ZUUL_UUID/***" --exclude="*" . rsync://10.68.16.255/doc

         # Options are confusing, setting them both to false ensures the
         # postbuildscript is ALWAYS run.
         onsuccess: False
         onfailure: False

    logrotate:
        daysToKeep: 15

- job-template:
    name: '{name}-docs'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul
    concurrent: true
    logrotate:
        daysToKeep: 15
    triggers:
     - zuul
    builders:
     - shell: |
         make docs
    publishers:
     - archive-log-dir

- job-template:
    name: '{name}-docs-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul
    logrotate:
        daysToKeep: 15
    triggers:
     - zuul
    builders:
     - assert-env-doc_subpath
     - shell: |
         make docs
     - doc-publish:
         docsrc: '{docsrc}'
         docdest: '{docdest}'
    publishers:
     - archive-log-dir

- job-template:
    name: '{name}-mwextdocs'
    node: contintLabsSlave && UbuntuTrusty
    logrotate:
        daysToKeep: 15
    triggers:
     - zuul
    builders:
     - zuul-cloner:
         projects: >
             mediawiki/core
             $ZUUL_PROJECT
     - shell: |
         export MW_INSTALL_PATH="$WORKSPACE/src"
         cd src/extensions/`basename $ZUUL_PROJECT`
         make docs

- job-template:
    name: '{name}-mwextdocs-publish'
    node: contintLabsSlave && UbuntuTrusty
    logrotate:
        daysToKeep: 15
    triggers:
     - zuul
    builders:
     - assert-env-doc_subpath
     - zuul-cloner:
         projects: >
             mediawiki/core
             $ZUUL_PROJECT
     - shell: |
         export MW_INSTALL_PATH="$WORKSPACE/src"
         cd src/extensions/`basename $ZUUL_PROJECT`
         make docs
     - doc-publish:
         docsrc: '{docsrc}'
         docdest: '{docdest}'

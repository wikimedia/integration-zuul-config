- job-template:
    name: 'mediawiki-vagrant-puppet-doc-publish'
    node: DebianJessieDocker
    concurrent: false
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-log-dir
     - docker-run-with-log-and-workspace-cache:
         image: 'docker-registry.wikimedia.org/releng/rake-vagrant:0.2.1'
         logdir: '/log'
         run_args: 'doc'
     - doc-publish:
        docsrc: 'doc'
        docdest: 'mediawiki-vagrant'
    publishers:
     - archive-log-allow-empty
     - castor-save-workspace-cache

- project:
    name: 'mediawiki-ruby-api'
    bundlecommand:
     - yard
    jobs:
     - '{name}-bundle-yard-publish'
     - '{name}-rake-docker'

- project:
    name: 'mediawiki-selenium'
    jobs:
     - '{name}-bundle-yard-publish'
     - '{name}-rake-docker'

# Run `bundle exec rake test` on Nodepool Jessie instances.
- job:
    name: 'mediawiki-vagrant-rake-jessie'
    node: ci-jessie-wikimedia
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - castor-load
     - bundle-nodepool:
         command: rake test
    publishers:
     - castor-save

- project:
    name: 'mediawiki-vagrant'
    jobs:
     - '{name}-rake-docker':
         docker_image_var: docker-registry.wikimedia.org/releng/rake-vagrant:0.2.1
         build_timeout: 10  # minutes
     - 'mediawiki-vagrant-puppet-doc-publish'

- project:
    name: 'mediawiki-vendor'
    jobs:
     - '{name}-composer-security':
         notify: security-team@wikimedia.org
         notify-every-unstable-build: false
         repository: mediawiki/vendor

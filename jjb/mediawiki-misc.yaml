- job-template:
    name: 'mediawiki-vagrant-puppet-doc-publish'
    node: DebianJessieDocker
    concurrent: false
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-log-dir
     - docker-src-dir
     - docker-run-with-log-cache-src:
         image: 'docker-registry.wikimedia.org/releng/rake-vagrant:0.2.1'
         logdir: '/log'
         args: 'doc'
     - doc-publish:
        docsrc: 'src/doc'
        docdest: 'mediawiki-vagrant'
    publishers:
     - archive-log-allow-empty
     - castor-save-workspace-cache
     - docker-cleanup

- project:
    name: 'mediawiki-ruby-api'
    bundlecommand:
     - yard
    jobs:
     - '{name}-bundle-yard-publish'
     - '{name}-rake-docker'

- project:
    name: 'mediawiki-selenium'
    jobs:
     - '{name}-bundle-yard-publish'
     - '{name}-rake-docker'

- project:
    name: 'mediawiki-vagrant'
    jobs:
     - '{name}-rake-docker':
         docker_image_var: docker-registry.wikimedia.org/releng/rake-vagrant:0.2.1
         build_timeout: 10  # minutes
     - 'mediawiki-vagrant-puppet-doc-publish'

- project:
    name: 'mediawiki-vendor'
    jobs:
     - '{name}-composer-security-docker':
         notify: security-team@wikimedia.org
         notify-every-unstable-build: false


- job:
    name: 'mediawiki-vendor-security'
    project-type: matrix
    execution-strategy:
        sequential: true
    parameters:
        - matrix-combinations:
            name: combo
            description: 'Select matrix combinations'
    axes:
        - axis:
            type: label-expression
            name: label
            values:
                - contint1001
        - axis:
            name: ZUUL_PROJECT
            type: user-defined
            values:
                - mediawiki/core
                - mediawiki/vendor
        - axis:
            name: ZUUL_BRANCH
            type: user-defined
            values:
                - master
                - REL1_31
                - REL1_30
                - REL1_27
    builders:
        - trigger-builds:
            - project: 'mediawiki-vendor-composer-security-docker'
              block: true
              predefined-parameters: |
                    projectName=mediawiki-vendor-composer-security-docker
                    ZUUL_URL=https://gerrit.wikimedia.org/r/p
                    ZUUL_PROJECT=$ZUUL_PROJECT
                    ZUUL_BRANCH=$ZUUL_BRANCH
                    ZUUL_REF=$ZUUL_BRANCH
    triggers:
        - timed: "H 20 * * *"

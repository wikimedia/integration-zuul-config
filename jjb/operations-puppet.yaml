# Documentation for our puppet repository
- job-template:
    name: 'operations-puppet-doc'
    node: ci-jessie-wikimedia
    defaults: use-remoteonly-zuul
    concurrent: false  # dont want to race doc creation!

    triggers:
     - pollscm:
         cron: '@hourly'
    scm:
     - git:
         url: 'https://gerrit.wikimedia.org/r/p/operations/puppet.git'
         branches:
             - production
         reference-repo: '/srv/git/operations/puppet.git'
         submodule:
             disable: false
             recursive: true
         basedir: 'src'

    builders:
     - puppet-doc:
        puppet: "$WORKSPACE/src"
     - doc-publish:
        docsrc: 'doc'
        docdest: 'puppet'
     # And publish the entire workspace as "puppetsource"
     - shell: |
         rm -fR src/.git
     - doc-publish:
        docsrc: 'src'
        docdest: 'puppetsource'
    publishers:
     - email-ext:
         recipients: qa-alerts@lists.wikimedia.org
         attach-build-log: true
         first-failure: true
         aborted: true
         failure: false
         fixed: true

- job-template:
    name: operations-puppet-catalog-compiler
    block-downstream: false
    block-upstream: false
    builders:
    - shell: CHANGE="${GERRIT_CHANGE_NUMBER}" NODES="${LIST_OF_NODES}" puppet-compiler
    concurrent: false
    description: |
      <p>Job is managed by <a href="https://www.mediawiki.org/wiki/CI/JJB">Jenkins Job Builder</a>.</p> <br />
      <p>The Puppet compiler. Use it to check your changes :)</p>
    disabled: false
    jdk: (System)
    node: compiler02.puppet3-diffs.eqiad.wmflabs
    parameters:
    - string:
        default: '2'
        description: Number of threads used on the labs instance to compile catalog.
          Don't use more than four!
        name: NUM_THREADS
    - string:
        default: ''
        description: The Gerrit change number (without patchset number) that will
          be fetched from Gerrit to compile the catalogs against Puppet version 2
          and 3.
        name: GERRIT_CHANGE_NUMBER
    - string:
        default: ''
        description: |-
          List of nodes (comma separated) to compile catalogs against.<br/>
          Leave blank to have the software select nodes for you (by parsing site.pp and matches that with the node list it had).
        name: LIST_OF_NODES
    project-type: freestyle
    properties:
    - build-discarder:
        artifact-days-to-keep: -1
        artifact-num-to-keep: -1
        days-to-keep: 60
        num-to-keep: -1

- project:
    name: 'operations-puppet'
    jobs:
     - '{name}-typos'
     - '{name}-tox-jessie'
     - operations-puppet-doc
     - operations-puppet-catalog-compiler

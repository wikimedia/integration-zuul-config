# Documentation for our puppet repository
- job-template:
    name: 'operations-puppet-doc'
    node: ci-jessie-wikimedia
    defaults: use-remoteonly-zuul
    concurrent: false  # dont want to race doc creation!

    # BUNDLE_PATH is usually injected by Zuul but this job is triggered by Jenkins
    parameters:
      - string:
          name: 'BUNDLE_PATH'
          default: '/home/jenkins/workspace/vendor/bundle'

    triggers:
     - pollscm:
         cron: '@hourly'
    scm:
     - git:
         url: 'https://gerrit.wikimedia.org/r/p/operations/puppet.git'
         branches:
             - production
         reference-repo: '/srv/git/operations/puppet.git'
         submodule:
             disable: false
             recursive: true
    builders:
     - bundle-nodepool:
         command: 'rake doc'
     - doc-publish:
        docsrc: 'doc'
        docdest: 'puppet'
    publishers:
     - email-ext:
         recipients: qa-alerts@lists.wikimedia.org
         attach-build-log: false
         first-failure: true
         aborted: true
         failure: false
         fixed: true

- job:
    name: 'operations-puppet-tests-jessie'
    node: ci-jessie-wikimedia
    concurrent: true
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul
    scm:
     - git:
         url: '$ZUUL_URL/$ZUUL_PROJECT'
         reference-repo: '/srv/git/${ZUUL_PROJECT}.git'
         branches:
          - '$ZUUL_COMMIT'
         refspec: '$ZUUL_REF'
         submodule:
             disable: false
             recursive: true
    builders:
     - castor-load
     - tox-all-envs
     - bundle-nodepool:
         command: rake test
    publishers:
     - xunit:
         types:
          - junit:
             pattern: 'log/junit*.xml'
             # rspec integration is not merged yet
             skip-if-no-test-files: true
             stoponerror: false
     - archive-log-dir
     - archive-tox-logs
     - castor-save

- job:
    name: 'operations-puppet-tests-docker'
    node: DebianJessieDocker
    concurrent: true
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul
    builders:
     - shell: |
         #!/bin/bash -eu

         set -x

         rm -rf log
         rm -rf .env

         cat <<ZUUL > .env
         ZUUL_URL=$ZUUL_URL
         ZUUL_PROJECT=$ZUUL_PROJECT
         ZUUL_COMMIT=$ZUUL_COMMIT
         ZUUL_REF=$ZUUL_REF
         HOME=/var/lib/jenkins
         ZUUL

         mkdir -p "log"

         docker run \
             --rm --tty \
             --env-file .env \
             --volume /srv/git:/srv/git:ro \
             --volume "$(pwd)"/log:/var/lib/jenkins/.cache/log \
             contint/operations-puppet
    publishers:
     - xunit:
         types:
          - junit:
             pattern: 'log/junit*.xml'
             # rspec integration is not merged yet
             skip-if-no-test-files: true
             stoponerror: false
     - archive-log-dir

- project:
    name: 'operations-puppet'
    jobs:
     - operations-puppet-doc

- project:
    name: 'puppet-modules'
    jobs:
     - '{name}-rake-jessie':
         name:
          - puppet-cdh
          - puppet-cdh4
          - puppet-jmxtrans
          - puppet-kafka
          - puppet-kafkatee
          - puppet-mariadb
          - puppet-nginx
          - puppet-varnishkafka
          - puppet-wikimetrics
          - puppet-zookeeper

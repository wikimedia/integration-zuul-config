- job-template:
    name: 'language-screenshots-{name}'
    project-type: matrix
    path_to_ci_yml: build/screenshots.yml
    yaml-strategy:
      exclude-key: 'exclude'
      filename: '{path_to_ci_yml}'
    axes:
      - axis:
          type: label-expression
          name: label
          values:
            - ci-jessie-wikimedia
      - axis:
          name: BROWSER
          type: yaml
          filename: '{path_to_ci_yml}'
      - axis:
          name: PLATFORM
          type: yaml
          filename: '{path_to_ci_yml}'

    node: ci-jessie-wikimedia
    repository_host: 'gerrit.wikimedia.org/r'

    logrotate:
        daysToKeep: 31  # ~ 2 * 2 weeks sprints

    scm:
      - git:
          url: https://{repository_host}/{repository}
          refspec: refs/changes/59/299159/9 # TODO: remove
          branches:
            - FETCH_HEAD # TODO: - master
          wipe-workspace: false  # keep the workspace...
          clean:
              after: true        # ... and use git clean instead
          prune: true            # prune remote obsoletes branches
          submodule:
              recursive: true

    builders:
      #- castor-load # TODO: enable caching

      - shell: |
          # credentials
          export SAUCE_ONDEMAND_USERNAME=wikimedia-jenkins
          set +x
          export MEDIAWIKI_PASSWORD="$LanguageScreenshotBot"
          set -x

          # installed dependencies
          node -v
          npm -v
          /usr/lib/chromium/chromedriver -v
          /usr/lib/chromium/chromium --version

          # install npm dependencies
          npm install

          # add chromedriver to PATH
          PATH=/usr/lib/chromium:$PATH
          which chromedriver

          # screenshot all the things
          # TODO: run screenshots-all when languages are fetched from build/screenshots.yml instead of build/screenshotLangs.json
          # TODO: node_modules/.bin/grunt screenshots-all
          node_modules/.bin/grunt screenshots

          # install ruby dependencies
          export BUNDLE_PATH='/home/jenkins/workspace/vendor/bundle'
          bundle install --verbose

          # upload all the things
          export MEDIAWIKI_API_UPLOAD_URL=https://commons.wikimedia.org/w/api.php
          export MEDIAWIKI_USER=LanguageScreenshotBot
          # TODO: get languages from build/screenshots.yml instead of build/screenshotLangs.json
          # TODO: the following two environment variable have language hard coded
          export LANGUAGE_SCREENSHOT_CATEGORY=VisualEditor-en
          export LANGUAGE_SCREENSHOT_CODE=en
          bundle exec upload

    publishers:
      #- castor-save # TODO: enable caching

      - email-ext:
          recipients: '{recipients}'
          body: '${{SCRIPT, template="wikimedia.template"}}'

      - browsertests-irc

      - claim-build

      - archive:
          artifacts: 'screenshots/*.png'

    wrappers:
      - ansicolor
      - timeout:
          timeout: 180
      - timestamps
      # Wiki usernames and passwords are hold in Jenkins credentials store
      # https://integration.wikimedia.org/ci/credential-store/domain/selenium/
      - credentials-binding:
          - text:
              credential-id: LanguageScreenshotBot
              variable: LanguageScreenshotBot
          - text:
              credential-id: sauce-ondemand-access-key
              variable: SAUCE_ONDEMAND_ACCESS_KEY

- project:
    name: wikimedia-fundraising-crm

    jobs:
      - '{name}-jslint'

- builder:
    name: fundraising-crm-install
    builders:
      - zuul-cloner:
          projects: >
            wikimedia/fundraising/civicrm-buildkit
            wikimedia/fundraising/crm
            wikimedia/fundraising/crm/civicrm
            wikimedia/fundraising/crm/drupal
      - shell: |
          $WORKSPACE/src/wikimedia/fundraising/crm/bin/ci-create-dbs.sh
          $WORKSPACE/src/wikimedia/fundraising/crm/bin/ci-populate-dbs.sh

- builder:
    name: fundraising-crm-phpunit
    builders:
      - shell: |
          cd $WORKSPACE/src/wikimedia/fundraising/crm
          $WORKSPACE/src/wikimedia/fundraising/crm/vendor/bin/phpunit \
            --log-junit $WORKSPACE/log/junit-phpunit.xml

- publisher:
    name: fundraising-crm-clean
    publishers:
     - postbuildscript:
         builders:
           - shell: |
               # FIXME: Some junk gets left behind (e.g. database dsn), which
               # corrupts later runs.  Remove it.  Ideally this cache would
               # be stored under $WORKSPACE and would be cleaned up without
               # an additional step.  Also, this causes a race condition,
               # the job can run concurrently once we fix this cache dir.
               rm -rf $HOME/.amp

               # Drop the MySQL databases.
               $WORKSPACE/src/wikimedia/fundraising/crm/bin/ci-drop-dbs.sh

         # Postbuild options are confusing, setting both to false ensures the script always runs.
         onsuccess: False
         onfailure: False

- project:
    # FIXME: rename
    name: wikimedia-fundraising-civicrm
    jobs:
      - wikimedia-fundraising-civicrm

- job:
    name: wikimedia-fundraising-civicrm
    # Run on isolated boxes because of messy MySQL behavior and unsafe fetches.
    node: contintLabsSlave && UbuntuTrusty
    # FIXME: due to the ~/.amp thing.
    concurrent: false
    triggers:
      - zuul
    builders:
      - fundraising-crm-install
      - fundraising-crm-phpunit
    publishers:
      - fundraising-crm-clean
      - phpunit-junit
      - archive-log-dir

- project:
    name: donation-interface-125
    jobs:
        - mwext-donationinterfacecore125-testextension-php53

- job:
    name: 'mwext-donationinterfacecore125-testextension-php53'
    # See mediawiki.yaml mediawiki-phpunit-{phpflavor}
    node: 'contintLabsSlave && ((UbuntuPrecise && phpflavor-php53) || (UbuntuTrusty && phpflavor-php53))'
    concurrent: true
    properties:
     - throttle-one-per-node
    triggers:
     - zuul
    builders:
     - assert-phpflavor:
         phpflavor: 'php53'
     - hhvm-clear-hhbc
     - prepare-mediawiki-125
     - mw-run-phpunit-allexts
    # TODO, find ways to additionaly run tests for core but
    # without extensions tests
    publishers:
     - junit:
        results: 'log/junit*.xml'
     - mw-teardown-mysql
     - archive-log-dir

- builder:
    name: prepare-mediawiki-125
    builders:
        - shell: |
            zuul-cloner --version
            zuul-cloner \
                --color \
                --verbose \
                --map /srv/deployment/integration/slave-scripts/etc/zuul-clonemap.yaml \
                --workspace src \
                --project-branch mediawiki/core=fundraising/REL1_25 \
                  https://gerrit.wikimedia.org/r/p \
                  extensions/DonationInterface extensions/ContributionTracking extensions/ParserFunctions extensions/DonationEmailUnsubscribe extensions/cldr skins/Vector vendor
        - mw-install-mysql
        - shell: "cp deps.txt src/extensions_load.txt"
        - mw-apply-settings
        - mw-run-update-script

- project:
    name: wikimedia-fundraising-tools

    jobs:
      - python-jobs

- project:
    name: wikimedia-fundraising-crm

    jobs:
      - '{name}-jslint'

- project:
    name: wikimedia-fundraising-SmashPig

    jobs:
      - python-jobs

- project:
    name: wikimedia-fundraising-slander

    jobs:
      - python-jobs

- builder:
    name: fundraising-crm-install
    builders:
      - zuul-cloner:
          projects: >
            wikimedia/fundraising/civicrm-buildkit
            wikimedia/fundraising/crm
            wikimedia/fundraising/crm/civicrm
            wikimedia/fundraising/crm/drupal
            wikimedia/fundraising/crm/vendor
      - shell: |
          $WORKSPACE/src/wikimedia/fundraising/crm/bin/ci-create-dbs.sh
          $WORKSPACE/src/wikimedia/fundraising/crm/bin/ci-populate-dbs.sh

- builder:
    name: fundraising-crm-phpunit
    builders:
      - shell: |
          cd $WORKSPACE/src/wikimedia/fundraising/crm
          $WORKSPACE/src/wikimedia/fundraising/civicrm-buildkit/bin/phpunit \
            --log-junit $WORKSPACE/log/junit-phpunit.xml

- publisher:
    name: fundraising-crm-clean
    publishers:
     - postbuildscript:
         builders:
           - shell: |
               # Symlink the .amp cache directory for easy cleanup.
               mkdir -p $WORKSPACE/.amp
               rm -rf $HOME/.amp
               ln -s $WORKSPACE/.amp $HOME/.amp

               # Drop the MySQL databases.
               $WORKSPACE/src/wikimedia/fundraising/crm/bin/ci-drop-dbs.sh

         # Postbuild options are confusing, setting both to false ensures the script always runs.
         onsuccess: False
         onfailure: False

- project:
    # FIXME: rename
    name: wikimedia-fundraising-civicrm
    jobs:
      - wikimedia-fundraising-civicrm

- job:
    name: wikimedia-fundraising-civicrm
    # Run on isolated boxes because of messy MySQL behavior and unsafe fetches.
    node: contintLabsSlave && UbuntuTrusty
    triggers:
      - zuul
    builders:
      - fundraising-crm-install
      - fundraising-crm-phpunit
    publishers:
      - fundraising-crm-clean
      - phpunit-junit
      - archive-log-dir

- builder:
    name: npm-install
    builders:
    - shell: |
        . /srv/deployment/integration/slave-scripts/bin/npm-setup.sh
        node --version
        npm --version
        rm -rf node_modules
        npm install

# Assert node version matches a basic regular expressions
#
# Parameter:
# * version: passed to `grep`
#
- builder:
    name: assert-node-version
    builders:
     - shell: |
         #!/bin/bash -e -u
         NODE_VERSION=`node --version`

         if ( echo "$NODE_VERSION" | grep "{version}" > /dev/null )
         then
             echo "Node version $NODE_VERSION matches '{version}'"
         else
             echo "Assertion error: node version $NODE_VERSION does not match '{version}'"
             exit 1
         fi

- builder:
    name: assert-node-version-6
    builders:
     - assert-node-version:
         version: ^v6[.]

- publisher:
    name: archive-log-dir
    publishers:
     - archive:
        artifacts: 'log/'

- publisher:
    name: archive-log-allow-empty
    publishers:
     - archive:
        artifacts: 'log/'
        allow-empty: true

# Validate a composer.json
- builder:
    name: composer-validate
    builders:
     - shell: |
        set -u
        cd "{dir}"
        [[ -f "composer.json" ]] || exit 0
        composer --ansi validate --no-check-publish

# Validate a composer.json so it can be published on packagist.org
- builder:
    name: composer-validate-package
    builders:
     - shell: |
        composer --ansi validate

- builder:
    name: composer-install
    builders:
     - shell: |
        set -ux
        cd "{dir}"
        [[ -f "composer.json" ]] || exit 0
        export HTTP_PROXY_REQUEST_FULLURI=false
        export HTTPS_PROXY_REQUEST_FULLURI=false
        composer install --ansi --no-progress --prefer-dist --profile -v

# Sends job duration (ms) to a statsd timer if node is labeled "stats-*",
# allowing for the collection and analysis of job performance on different
# groups of nodes.
#
# The stat keys created are "jenkins.{label}" where {label} is the "stats-*"
# node label. Note that job name is not included in the key, so only schedule
# this publisher for one job at a time to collect stats from builds of a
# consistent set of conditions (job, project, branch, etc.).
#
- publisher:
    name: record-node-stats
    publishers:
     - groovy-postbuild:
        script: !include-raw: record-node-stats.groovy

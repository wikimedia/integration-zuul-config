# Same as the generic job, but kept separate so that gate-and-submit jobs
# don't cross-block between mediawiki/* and non-mediawiki changes.
#
# Deprecated: Use 'mwext-node10-rundoc-docker' instead.
- job:
    name: 'mwext-jsduck-publish'
    node: DebianJessieDocker
    concurrent: false
    triggers:
     - zuul
    builders:
     - docker-log-dir
     - docker-src-dir
     - docker-ci-src-setup-simple
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/jsduck:0.1.0
         logdir: '/log'
     - doc-publish:
        docsrc: 'src/docs'
        docdest: '$DOC_BASENAME/$ZUUL_BRANCH/js'
    publishers:
     - archive-log-allow-empty
     - docker-cleanup

- project:
    name: wmf-sonar-scanner
    jobs:
      - wmf-sonar-scanner-{name}:
         # Used for analyzing gerrit patch sets.
         name: 'change'
         branch: '$ZUUL_CHANGE'
         args: |
             -Dsonar.projectKey=${{ZUUL_PROJECT//\//-}} \
             -Dsonar.projectName=${{ZUUL_PROJECT//\//-}} \
             -Dsonar.organization=wmftest \
             -Dsonar.host.url=https://sonarcloud.io \
             -Dsonar.branch.target="$ZUUL_BRANCH" \
             -Dsonar.branch.name={branch} \
             -X
      - wmf-sonar-scanner-{name}:
         # Used for analyzing the master branch on postmerge.
         name: 'branch-non-voting'
         branch: '$ZUUL_BRANCH'
         args: |
             -Dsonar.projectKey=${{ZUUL_PROJECT//\//-}} \
             -Dsonar.projectName=${{ZUUL_PROJECT//\//-}} \
             -Dsonar.organization=wmftest \
             -Dsonar.host.url=https://sonarcloud.io \
             -X

- job-template:
    name: 'wmf-sonar-scanner-{name}'
    node: DebianJessieDocker
    concurrent: false
    branch: '$ZUUL_BRANCH'
    properties:
     - build-discarder:
         days-to-keep: 15
    triggers:
     - zuul
    builders:
    - docker-log-dir
    - docker-src-dir
    - docker-cache-dir
    - docker-ci-src-setup-simple
    - docker-run-with-log-cache-src:
       image: 'docker-registry.wikimedia.org/releng/java8-sonar-scanner:0.4.0'
       logdir: '/log'
       args: '{args}'
    wrappers:
     - ansicolor
     - timeout:
         timeout: 30
         fail: true
     - timestamps
     # SONAR_API_KEY is in Jenkins credentials store
     # https://integration.wikimedia.org/ci/credentials/
     - credentials-binding:
           - text:
               credential-id: SONAR_API_KEY
               variable: SONAR_API_KEY
    publishers:
        - docker-cleanup

- job: # Identical to mwext-VisualEditor-docker-publish except docsrc and docdest.
    name: 'mwext-npm-doc-publish'
    node: DebianJessieDocker
    concurrent: false
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-log-dir
     - docker-src-dir
     - docker-ci-src-setup-simple
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/npm-test:0.6.0
         args: 'doc'
         logdir: '/log'
     - doc-publish:
        docsrc: 'src/docs/js'
        docdest: '$DOC_BASENAME/$ZUUL_BRANCH/js'
    publishers:
     - archive-log-allow-empty
     - castor-save-workspace-cache
     - docker-cleanup

- job:
    name: 'mwext-VisualEditor-docker-publish'
    node: DebianJessieDocker
    concurrent: false
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-log-dir
     - docker-src-dir
     - docker-ci-src-setup-simple
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/npm-test:0.6.0
         args: 'doc'
         logdir: '/log'
     - doc-publish:
        docsrc: 'src/docs'
        docdest: 'VisualEditor/$ZUUL_BRANCH'
    publishers:
     - archive-log-allow-empty
     - castor-save-workspace-cache
     - docker-cleanup

- job:
    name: 'mwext-doxygen-publish'
    node: DebianJessieDocker
    concurrent: false
    triggers:
     - zuul
    builders:
     - docker-log-dir
     - docker-src-dir
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/doxygen:0.4.1
         logdir: '/log'
     - doc-publish:
        docsrc: 'src/docs/php'
        docdest: '$DOC_BASENAME/$DOC_SUBPATH/php'
    archive:
     - archive-log-allow-empty
     - docker-cleanup

# Phan! (T153039)
- job: &job_mwext-php70-phan-docker
    name: 'mwext-php70-phan-docker'
    node: DebianJessieDocker && m4executor
    concurrent: true
    properties:
     - build-discarder:
         days-to-keep: 15
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-log-dir
     - docker-src-dir
     - docker-ci-src-setup-mwext
     - docker-run-with-log-cache-src:
        options: '--volume "$(pwd)"/src:/mediawiki'
        image: 'docker-registry.wikimedia.org/releng/mediawiki-phan:0.1.11'
        args: '/$ZUUL_PROJECT -m checkstyle'
        logdir: '/log'

    publishers:
     - checkstyle:
        pattern: 'log/phan-issues'
        can-run-on-failed: true
        thresholds:
          failed:
            total-all: 1
     - castor-save-workspace-cache
     - docker-cleanup

- job:
    name: 'mwskin-php70-phan-docker'
    !!merge : *job_mwext-php70-phan-docker
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul


- job:
    name: 'mediawiki-i18n-check-docker'
    node: DebianJessieDocker
    triggers:
     - zuul
    builders:
     - docker-src-dir
     - docker-ci-src-setup-simple
     # It's not really worth creating a docker image for this pretty
     # "simple" bash script
     - shell: |
        #!/bin/bash
        set -euxo pipefail
        cd src

        echo noop

- job: &job_mwext-php70-phan-seccheck-docker
    name: 'mwext-php70-phan-seccheck-docker'
    node: DebianJessieDocker && m4executor
    concurrent: true
    properties:
     - build-discarder:
         days-to-keep: 15
    triggers:
     - zuul
    builders:
     - docker-castor-load
     - docker-log-dir
     - docker-src-dir
     - docker-ci-src-setup-mwext
     - docker-run-with-log-cache-src:
         image: docker-registry.wikimedia.org/releng/mediawiki-phan-seccheck:0.3.2
         options: '--volume "$(pwd)"/src:/mediawiki'
         args: '-m checkstyle'
         logdir: '/log'
    publishers:
     - checkstyle:
        pattern: 'src/seccheck-issues'
        can-run-on-failed: true
        thresholds:
          failed:
            total-all: 1
     - castor-save-workspace-cache
     - docker-cleanup

- job:
    name: 'mwext-php70-phan-seccheck-docker-non-voting'
    !!merge : *job_mwext-php70-phan-seccheck-docker
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul

- job:
    name: 'mwskin-php70-phan-seccheck-docker'
    !!merge : *job_mwext-php70-phan-seccheck-docker
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul

- job:
    name: 'mwskin-php70-phan-seccheck-docker-non-voting'
    !!merge : *job_mwext-php70-phan-seccheck-docker
    # Reinject Zuul parameters since JJB strip for some reason
    triggers:
     - zuul

- project:
    name: 'mwext-MobileFrontend'
    jobs:
     - 'mwext-MobileFrontend-npm-run-lint-modules-docker'

- project:
    name: 'mwext-VisualEditor'
    jobs:
     - '{name}-jsduck-docker'

- project:
    name: wdio-selenium-daily
    project:
        - AdvancedSearch:
            recipients: fundraising-tech@wikimedia.de qa-alerts@lists.wikimedia.org zfilipin@wikimedia.org # @zeljkofilipin
            repository: mediawiki/extensions/AdvancedSearch
            site: en.wikipedia
        - CirrusSearch:
            recipients: dcausse@wikimedia.org ebernhardson@wikimedia.org qa-alerts@lists.wikimedia.org # @dcausse @EBernhardson
            repository: mediawiki/extensions/CirrusSearch
            site: en.wikipedia
            docker_image_var: 'docker-registry.wikimedia.org/releng/npm-browser-test:0.4.1'
        - Echo:
            recipients: etonkovidova@wikimedia.org qa-alerts@lists.wikimedia.org # @Etonkovidova
            repository: mediawiki/extensions/Echo
            site: en.wikipedia
            docker_image_var: 'docker-registry.wikimedia.org/releng/npm-browser-test:0.4.1'
        - Math:
            recipients: qa-alerts@lists.wikimedia.org wiki@physikerwelt.de # @Physikerwelt
            repository: mediawiki/extensions/Math
            site: en.wikipedia
            docker_image_var: 'docker-registry.wikimedia.org/releng/npm-browser-test:0.4.1'
        - Minerva:
            recipients: qa-alerts@lists.wikimedia.org jrobson@wikimedia.org # @Jdlrobson
            repository: mediawiki/skins/MinervaNeue
            site: en.wikipedia
            docker_image_var: 'docker-registry.wikimedia.org/releng/npm-browser-test:0.4.1'
        - MobileFrontend:
            recipients: jrobson@wikimedia.org qa-alerts@lists.wikimedia.org # @Jdlrobson
            repository: mediawiki/extensions/MobileFrontend
            site: en.wikipedia
            docker_image_var: 'docker-registry.wikimedia.org/releng/npm-browser-test:0.4.1'
        - Newsletter:
            recipients: qa-alerts@lists.wikimedia.org 01tonythomas@gmail.com # @01tonythomas
            repository: mediawiki/extensions/Newsletter
            site: en.wikipedia
            docker_image_var: 'docker-registry.wikimedia.org/releng/npm-browser-test:0.4.1'
        - Popups:
            recipients: jrobson@wikimedia.org qa-alerts@lists.wikimedia.org samsmith@wikimedia.org # @Jdlrobson @phuedx
            repository: mediawiki/extensions/Popups
            site: en.wikipedia
            docker_image_var: 'docker-registry.wikimedia.org/releng/npm-browser-test:0.4.1'
        - RelatedArticles:
            recipients: jrobson@wikimedia.org qa-alerts@lists.wikimedia.org samsmith@wikimedia.org # @Jdlrobson @phuedx
            repository: mediawiki/extensions/RelatedArticles
            site: en.wikipedia
            docker_image_var: 'docker-registry.wikimedia.org/releng/npm-browser-test:0.4.1'
        - Wikibase:
            recipients: qa-alerts@lists.wikimedia.org wikidata-ci-status@wikimedia.de
            repository: mediawiki/extensions/Wikibase
            site: wikidata
            docker_image_var: 'docker-registry.wikimedia.org/releng/npm-browser-test:0.4.1'
    jobs:
        - 'selenium-daily-beta-{project}'

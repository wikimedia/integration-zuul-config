# This is the non-generic npm job. Most extensions
# should just need to add "npm" in their zuul config.
# Only VisualEditor uses this as it needs to checkout
# submodules.
- job-template:
    name: '{name}-{ext-name}-npm'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    concurrent: true
    triggers:
     - zuul
    builders:
     - npm
    publishers:
     - global-teardown

# Parameters:
#
# ext-name: extension basename. Set to '' to ignore
# dependencies: comma or spaces/newlines separated list of extensions to clone
# additional-dependencies: gets appended to dependencies, backslash escaping is applied, use \n to separate multiple
#
- builder:
    name: 'zuul-cloner-extdeps'
    builders:
     - shell: |
         # Build dependencies list
         rm -f deps.txt
         touch deps.txt
         echo "mediawiki/core" >> deps.txt
         if [ "{additional-repositories}" != "" ]; then
             echo -e "{additional-repositories}" >> deps.txt
         fi
         if [ "{ext-name}" != "" ]; then
            echo "mediawiki/extensions/{ext-name}" >> deps.txt
         fi
         if [ "{dependencies}" != "" ]; then
             echo "$(IFS=', '; for dep in `echo {dependencies}`; do echo mediawiki/extensions/$dep; done;)" >> deps.txt
         fi
     - zuul-cloner:
         projects: >
             $(cat deps.txt)
     - ve-submodules-update

# ALWAYS pair with 'mw-teardown-mysql'
- builder:
    name: prepare-mediawiki
    builders:
     - zuul-cloner-extdeps:
         ext-name: '{ext-name}'
         dependencies: '{dependencies}'
         additional-repositories: 'mediawiki/vendor'
     - mw-install-mysql
     - shell: "cp deps.txt src/extensions_load.txt"
     - mw-apply-settings
     - mw-run-update-script

# Workaround zuul-cloner not processing submodules
- builder:
    name: ve-submodules-update
    builders:
     - shell: |
         if grep -q mediawiki/extensions/VisualEditor deps.txt; then
            cd src/extensions/VisualEditor
            git submodule update --init
            git submodule status
            git submodule foreach git clean -xdff -q
         fi

# ALWAYS pair with 'mw-teardown-mysql'
# Similar to prepare-mediawiki, except gets
# the extension name from $ZUUL_PROJECT
- builder:
    name: prepare-mediawiki-zuul-project
    builders:
     - shell: "echo $ZUUL_PROJECT > extensions_load.txt"
     - shell: "echo -e $EXT_DEPENDENCIES >> extensions_load.txt"
     - zuul-cloner:
         projects: >
             mediawiki/core
             mediawiki/vendor
             $(cat extensions_load.txt)
     - shell: "mv extensions_load.txt src/extensions_load.txt"
     - shell: |
         if grep -q mediawiki/extensions/VisualEditor src/extensions_load.txt; then
            cd src/extensions/VisualEditor
            git submodule update --init
         fi
     - mw-install-mysql
     - mw-apply-settings
     - mw-run-update-script
# same except for use with composer instead of cloning vendor
- builder:
    name: prepare-mediawiki-zuul-project-no-vendor
    builders:
     - shell: "echo $ZUUL_PROJECT > extensions_load.txt"
     - shell: "echo -e $EXT_DEPENDENCIES >> extensions_load.txt"
     - zuul-cloner:
         projects: >
             mediawiki/core
             $(cat extensions_load.txt)
     - shell: "mv extensions_load.txt src/extensions_load.txt"
     - shell: |
         if grep -q mediawiki/extensions/VisualEditor src/extensions_load.txt; then
            cd src/extensions/VisualEditor
            git submodule update --init
         fi
     - composer-validate:
         dir: 'src'
     - composer-local-create:
         deps: 'extensions_load.txt'
     - composer-update:
         dir: 'src'
     - mw-install-mysql
     - mw-apply-settings
     - mw-run-update-script

# Generic qunit job for extensions.
- job:
    name: 'mwext-qunit'
    node: contintLabsSlave && UbuntuTrusty
    concurrent: true
    triggers:
     - zuul
    builders:
     - prepare-mediawiki-zuul-project
     - qunit-karma
    publishers:
     - localhost-cleanup
     - mw-teardown-mysql
     - archive-log-dir

# Generic qunit job for extensions with composer update.
- job:
    name: 'mwext-qunit-composer'
    node: contintLabsSlave && UbuntuTrusty
    concurrent: true
    triggers:
     - zuul
    builders:
     - prepare-mediawiki-zuul-project-no-vendor
     - qunit-karma
    publishers:
     - localhost-cleanup
     - mw-teardown-mysql
     - archive-log-dir

# Generic mw-selenium job for extensions.
- job:
    name: 'mwext-mw-selenium'
    node: contintLabsSlave && UbuntuTrusty
    concurrent: true
    triggers:
     - zuul
    builders:
     - prepare-mediawiki-zuul-project
     - zuul-cloner:
         projects: mediawiki/skins/Vector
     - mw-selenium
    publishers:
     - mw-selenium-cleanup
     - localhost-cleanup
     - mw-teardown-mysql
     - archive-log-dir
    logrotate:
      daysToKeep: 15
      artifactDaysToKeep: 3

# Generic mw-selenium job for extensions.
- job:
    name: 'mwext-mw-selenium-composer'
    node: contintLabsSlave && UbuntuTrusty
    concurrent: true
    triggers:
     - zuul
    builders:
     - prepare-mediawiki-zuul-project-no-vendor
     - zuul-cloner:
         projects: mediawiki/skins/Vector
     - mw-selenium
    publishers:
     - mw-selenium-cleanup
     - localhost-cleanup
     - mw-teardown-mysql
     - archive-log-dir
    logrotate:
      daysToKeep: 15
      artifactDaysToKeep: 3

- job-template:
    name: 'mwext-{name}-whitespaces'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    concurrent: true
    logrotate:
        daysToKeep: 15
    triggers:
     - zuul
    builders:
     - lint-whitespaces

# Run extension tests via Zuul cloner
#
- job-template:
    name: '{name}-{ext-name}-testextension-{phpflavor}'
    # See mediawiki.yaml mediawiki-phpunit-{phpflavor}
    node: 'contintLabsSlave && phpflavor-{phpflavor}'
    concurrent: true
    properties:
     - throttle-one-per-node
    triggers:
     - zuul
    builders:
     - assert-phpflavor:
         phpflavor: '{phpflavor}'
     - hhvm-clear-hhbc
     - prepare-mediawiki:
         ext-name: '{ext-name}'
         dependencies: '{dependencies}'
     - mw-fetch-composer-dev
     - mw-run-phpunit-allexts
    # TODO, find ways to additionaly run tests for core but
    # without extensions tests
    publishers:
     - junit:
        results: 'log/junit*.xml'
     - mw-teardown-mysql
     - archive-log-dir

# Generic phpunit job for extensions.
- job-template:
    name: 'mwext-testextension-{phpflavor}'
    node: 'contintLabsSlave && phpflavor-{phpflavor}'
    concurrent: true
    triggers:
     - zuul
    builders:
     - assert-phpflavor:
         phpflavor: '{phpflavor}'
     - hhvm-clear-hhbc
     - prepare-mediawiki-zuul-project
     - mw-fetch-composer-dev
     - mw-run-phpunit-allexts
    publishers:
     - junit:
        results: 'log/junit*.xml'
     - mw-teardown-mysql
     - archive-log-dir

# Same as above, but with non-voting suffix because it's non-voting
- job-template:
    name: 'mwext-testextension-{phpflavor}-non-voting'
    node: 'contintLabsSlave && phpflavor-{phpflavor}'
    concurrent: true
    triggers:
     - zuul
    builders:
     - assert-phpflavor:
         phpflavor: '{phpflavor}'
     - hhvm-clear-hhbc
     - prepare-mediawiki-zuul-project
     - mw-run-phpunit-allexts
    publishers:
     - junit:
        results: 'log/junit*.xml'
     - mw-teardown-mysql
     - archive-log-dir


# same but with composer update instead of cloning vendor
- job-template:
    name: 'mwext-testextension-{phpflavor}-composer'
    node: 'contintLabsSlave && phpflavor-{phpflavor}'
    concurrent: true
    triggers:
     - zuul
    builders:
     - assert-phpflavor:
         phpflavor: '{phpflavor}'
     - hhvm-clear-hhbc
     - prepare-mediawiki-zuul-project-no-vendor
     - mw-run-phpunit-allexts
    publishers:
     - junit:
        results: 'log/junit*.xml'
     - mw-teardown-mysql
     - archive-log-dir

- project:
    name: 'mwext-testextension-generic'
    jobs:
     - 'mwext-testextension-{phpflavor}':
        phpflavor:
            - hhvm
            - php53
            - php55
     - 'mwext-testextension-{phpflavor}-non-voting':
        phpflavor:
            - hhvm
            - php53
            - php55
     - 'mwext-testextension-{phpflavor}-composer':
        phpflavor:
            - hhvm
            - php53
            - php55

- job:
    name: 'mwext-jsduck-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - jsduck
     - doc-publish:
        docsrc: 'docs'
        docdest: '$DOC_BASENAME/$ZUUL_BRANCH/js'

- job-template:
    name: 'mwext-PoolCounter-build'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    triggers:
     - zuul
    builders:
     - shell: |
        cd daemon
        make

- job:
    name: 'mwext-VisualEditor-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    concurrent: false
    triggers:
     - zuul
    builders:
     - npm-install
     - npm-run-doc
     - doc-publish:
        docsrc: 'docs'
        docdest: 'VisualEditor/$ZUUL_BRANCH'
    publishers:
     - global-teardown

- job:
    name: 'mwext-MobileFrontend-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    concurrent: false
    triggers:
     - zuul
    builders:
     - npm-install
     - npm-run-doc
     - doc-publish:
        docsrc: 'docs'
        docdest: 'MobileFrontend/$ZUUL_BRANCH/js'
    publishers:
     - global-teardown

- job:
    name: 'mwext-MobileFrontend-doxygen-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - global-setup
     - doxygen
     - doc-publish:
        docsrc: 'docs/php'
        docdest: 'MobileFrontend/$DOC_SUBPATH/php'
    publishers:
     - global-teardown

- job-template:
    name: 'mwext-VisualEditor-sync-gerrit'  # bug 49846
    node: gallium  # needs 'jenkins' user which has the 'jenkins-bot' SSH credentials
    concurrent: false
    logrotate:
        daysToKeep: 30
    triggers:
     - zuul
    builders:
     - shell: /srv/deployment/integration/slave-scripts/bin/gerrit-sync-ve.sh
     - shell: sudo -u jenkins /srv/deployment/integration/slave-scripts/bin/gerrit-sync-ve-push.sh

- project:
    name: mwext

    # By default we do not need any other extensions:
    dependencies: ""

    ext-name:
     - Babel
     - CheckUser
     - CiteThisPage
     - cldr
     - ConfirmEdit
     - DonationInterface:
        dependencies: 'ContributionTracking'
     - Echo
     - EventLogging
     - Flow:
        dependencies: 'AbuseFilter,SpamBlacklist,CheckUser,Echo,EventLogging,ConfirmEdit,VisualEditor,GuidedTour'
     - JsonConfig
     - Maps:
        dependencies: 'Validator'
     - MobileApp:
        dependencies: 'Echo,MobileFrontend,VisualEditor'
     - SandboxLink
     - SpamBlacklist
     - SyntaxHighlight_GeSHi
     - Thanks:
        dependencies: 'Echo,Flow,MobileFrontend,VisualEditor,GuidedTour,AbuseFilter,SpamBlacklist,CheckUser,EventLogging,ConfirmEdit'
     - TitleBlacklist:
        dependencies: 'AntiSpoof'
     - Translate:
        dependencies: 'UniversalLanguageSelector,EventLogging,cldr'
     - UniversalLanguageSelector:
        dependencies: 'EventLogging'
     - VisualEditor
     - ZeroBanner:
        dependencies: 'Echo,JsonConfig,MobileFrontend,VisualEditor'
     - ZeroPortal:
        dependencies: 'Echo,JsonConfig,MobileFrontend,VisualEditor,ZeroBanner'

    jobs:
     - '{name}-{ext-name}-testextension-{phpflavor}':
         phpflavor:
             - hhvm
             - php53
             - php55

     - '{name}-{ext-name}-npm':
        ext-name: VisualEditor
     - 'mwext-MobileFrontend-publish'


# Deprecated, extensions should be converted
# to use an npm entry point instead.
- project:
    name: legacy-mwext-jslint
    jobs:
     - '{name}-jslint':
        name:
          - mwext-ApiExplorer
          - mwext-ArticleCreationWorkflow
          - mwext-ArticleFeedback
          - mwext-ArticleIndex
          - mwext-BiblioPlus
          - mwext-BibManager
          - mwext-BreadCrumbs2
          - mwext-Carp
          - mwext-CategorySlideShow
          - mwext-CategorySortHeaders
          - mwext-CategoryTests
          - mwext-CentralLogging
          - mwext-Checkpoint
          - mwext-CloseWikis
          - mwext-Commentbox
          - mwext-CommunityVoice
          - mwext-Contest
          - mwext-ContributionReporting
          - mwext-Convert2Wiki
          - mwext-CopyToClipboard
          - mwext-CreatePage
          - mwext-CreditTab
          - mwext-CryoKey
          - mwext-CSS
          - mwext-CustomUserSignup
          - mwext-DataTransfer
          - mwext-DeleteOwn
          - mwext-Description2
          - mwext-DeviceMapLogCapture
          - mwext-Diagnosis
          - mwext-Dice
          - mwext-DidYouKnow
          - mwext-DidYouMean
          - mwext-DisqusTag
          - mwext-DjangoAnalytics
          - mwext-DownloadCounter
          - mwext-DPLforum
          - mwext-Drafts
          - mwext-DumpHTML
          - mwext-Duplicator
          - mwext-DynamicPageList
          - mwext-EditSubpages
          - mwext-EnhanceContactForm
          - mwext-ErrorHandler
          - mwext-EtherpadLite
          - mwext-examples
          - mwext-ExternalArticles
          - mwext-ExternalData
          - mwext-ExtraLanguageLink
          - mwext-ExtTab
          - mwext-FanBoxes
          - mwext-FeedsFromPrivateWikis
          - mwext-FilterListUsers
          - mwext-FirstSteps
          - mwext-FlvHandler
          - mwext-ForcePreview
          - mwext-FormatDates
          - mwext-FormatNum
          - mwext-FormelApplet
          - mwext-Foxway
          - mwext-FundraisingChart
          - mwext-Genderize
          - mwext-GlobalNotice
          - mwext-GlobalUserGroups
          - mwext-GlobalUserrights
          - mwext-googleAnalytics
          - mwext-GoogleDocs4MW
          - mwext-GoogleDocTag
          - mwext-GoogleMaps
          - mwext-GooglePlusOne
          - mwext-GroupsSidebar
          - mwext-HashTables
          - mwext-HeaderTabs
          - mwext-HelpCommons
          - mwext-HidePrefix
          - mwext-HostStats
          - mwext-Hovergallery
          - mwext-HSTS
          - mwext-HTMLets
          - mwext-HTMLTags
          - mwext-IframePage
          - mwext-IfTemplates
          - mwext-ImageLink
          - mwext-IndexFunction
          - mwext-InlineCategorizer
          - mwext-InteractiveBlockMessage
          - mwext-Interlanguage
          - mwext-InterwikiMagic
          - mwext-JSBreadCrumbs
          - mwext-JsonData
          - mwext-LanguageSelector
          - mwext-LanguageTag
          - mwext-LastModified
          - mwext-Less
          - mwext-LifeWeb
          - mwext-LifeWebCore
          - mwext-LightweightRDFa
          - mwext-Limn
          - mwext-LinkFilter
          - mwext-ListSignup
          - mwext-LiveTranslate
          - mwext-Lockdown
          - mwext-LockDownEnglishPages
          - mwext-LogEntry
          - mwext-LogoFunctions
          - mwext-LookupUser
          - mwext-LoopFunctions
          - mwext-Loops
          - mwext-MagicNoCache
          - mwext-Maps
          - mwext-MassEditRegex
          - mwext-MediaFunctions
          - mwext-MediaWikiAuth
          - mwext-MediaWikiChat
          - mwext-Minifier
          - mwext-Model
          - mwext-Moodle
          - mwext-Mpdf
          - mwext-MsLinks
          - mwext-MSSQLBackCompat
          - mwext-MultimediaPlayer
          - mwext-MultiUpload
          - mwext-NamespaceHTML
          - mwext-NamespacePaths
          - mwext-NamespaceRelations
          - mwext-Negref
          - mwext-NetworkAuth
          - mwext-News
          - mwext-NewsBox
          - mwext-NewSignupPage
          - mwext-NewUsersList
          - mwext-Nonlinear
          - mwext-NoTitle
          - mwext-NSFileRepo
          - mwext-NukeDPL
          - mwext-NumberFormat
          - mwext-NumberOfWikis
          - mwext-Numbertext
          - mwext-NumerAlpha
          - mwext-OdbcDatabase
          - mwext-OfflineImportLexicon
          - mwext-OnlineStatusBar
          - mwext-OnlyRecentRecentChanges
          - mwext-OpenGraphMeta
          - mwext-OpenStreetMapSlippyMap
          - mwext-OracleTextSearch
          - mwext-Oversight
          - mwext-PageCreationNotif
          - mwext-PageDisqus
          - mwext-PageInCat
          - mwext-PageLanguage
          - mwext-PageNotice
          - mwext-PageSchemas
          - mwext-PageTools
          - mwext-PanScroll
          - mwext-PdfBook
          - mwext-PdfExport
          - mwext-PerPageLicense
          - mwext-Persona
          - mwext-PGFTikZ
          - mwext-Phalanx
          - mwext-PhpHighlight
          - mwext-PhpTagsMaps
          - mwext-PhpTagsSMW
          - mwext-PictureGame
          - mwext-Poll
          - mwext-PollNY
          - mwext-Polyglot
          - mwext-PrefStats
          - mwext-PrefSwitch
          - mwext-Premoderation
          - mwext-PrivateDomains
          - mwext-ProtectSite
          - mwext-PubSubHubbub
          - mwext-PurgeClickThrough
          - mwext-Push
          - mwext-PushToWatch
          - mwext-Quantcast
          - mwext-QuickResponse
          - mwext-QuizGame
          - mwext-QuizTabulate
          - mwext-RandomFeaturedUser
          - mwext-RandomGameUnit
          - mwext-RandomImage
          - mwext-RandomImageByCategory
          - mwext-RandomInCategory
          - mwext-RandomUsersWithAvatars
          - mwext-Ratings
          - mwext-RDFIO
          - mwext-ReassignEdits
          - mwext-RefreshSpecial
          - mwext-RegexFun
          - mwext-RegexFunctions
          - mwext-RelationLinks
          - mwext-ReplaceSet
          - mwext-ReplaceText
          - mwext-RevisionCommentSupplement
          - mwext-RightFunctions
          - mwext-RT
          - mwext-Sarcasm
          - mwext-ScanSet
          - mwext-Screenplay
          - mwext-SearchRealnames
          - mwext-SectionDisqus
          - mwext-SecureHTML
          - mwext-SecurePasswords
          - mwext-SecureSessions
          - mwext-SelectCategory
          - mwext-SelectTag
          - mwext-SemanticComments
          - mwext-SemanticExpressiveness
          - mwext-SemanticHighcharts
          - mwext-SemanticImageInput
          - mwext-SemanticMaps
          - mwext-SemanticRating
          - mwext-SemanticResultFormats
          - mwext-SemanticSifter
          - mwext-SemanticWatchlist
          - mwext-SemanticWebBrowser
          - mwext-SharedCssJs
          - mwext-ShoutBox
          - mwext-SidebarDonateBox
          - mwext-SideBarMenu
          - mwext-SignWritingMediaWikiPlugin
          - mwext-SimpleChanges
          - mwext-SimpleSecurity
          - mwext-SimpleSurvey
          - mwext-SiteMetrics
          - mwext-SkinPerNamespace
          - mwext-SlimboxThumbs
          - mwext-SmoothGallery
          - mwext-SocialProfile
          - mwext-SoftwareVersion
          - mwext-SolrStore
          - mwext-SoundManager2Button
          - mwext-Spark
          - mwext-Special404
          - mwext-SpellingApi
          - mwext-SphinxSearch
          - mwext-SportsTeams
          - mwext-SSLClientAuthentication
          - mwext-StaffEdits
          - mwext-StalkerLog
          - mwext-StarterWiki
          - mwext-StringFunctionsEscaped
          - mwext-SubpageFun
          - mwext-Suhosin
          - mwext-Survey
          - mwext-SVGEdit
          - mwext-SwarmExport
          - mwext-SwiftMailer
          - mwext-Tabber
          - mwext-Tabs
          - mwext-TemplateInfo
          - mwext-ThemeDesigner
          - mwext-ThrottleOverride
          - mwext-ThumbParser
          - mwext-TimelineTable
          - mwext-TimeMachine
          - mwext-TimezoneSelector
          - mwext-TitleIcon
          - mwext-TranslateSvg
          - mwext-TweetANew
          - mwext-UIFeedback
          - mwext-UserStatus
          - mwext-Vine
          - mwext-VirtualKeyboard
          - mwext-VoteNY
          - mwext-WebPlatformSearchAutocomplete
          - mwext-Widgets
          - mwext-WikiArticleFeeds
          - mwext-WikibaseMobile
          - mwext-WikiCategoryTagCloud
          - mwext-WikidataEntitySuggester
          - mwext-WikiLovesMonuments
          - mwext-WikiTwidget
          - mwext-WikivoteMapsYandex
          - mwext-WYSIWYG
          - mwext-XMLContentExtension

- project:
    name: 'mwext-CirrusSearch'
    jobs:
     - 'mwext-{name}-whitespaces':
        name: CirrusSearch

- project:
    name: 'mwext-PoolCounter'
    jobs:
     - 'mwext-PoolCounter-build'

- project:
    name: 'mwext-VisualEditor'
    jobs:
     - '{name}-jsduck'
     - 'mwext-VisualEditor-sync-gerrit'

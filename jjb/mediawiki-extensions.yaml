# This is the non-generic npm job. Most extensions
# should just need to add "npm" in their zuul config.
# Only VisualEditor uses this as it needs to checkout
# submodules.
- job-template:
    name: '{name}-{ext-name}-npm'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    concurrent: true
    triggers:
     - zuul
    builders:
     - npm
    publishers:
     - global-teardown

# Parameters:
#
# ext-name: extension basename. Set to '' to ignore
# dependencies: comma or spaces/newlines separated list of extensions to clone
# additional-dependencies: gets appended to dependencies, backslash escaping is applied, use \n to separate multiple
#
- builder:
    name: 'zuul-cloner-extdeps'
    builders:
     - shell: |
         # Build dependencies list
         rm -f deps.txt
         touch deps.txt
         echo "mediawiki/core" >> deps.txt
         if [ "{additional-repositories}" != "" ]; then
             echo -e "{additional-repositories}" >> deps.txt
         fi
         if [ "{ext-name}" != "" ]; then
            echo "mediawiki/extensions/{ext-name}" >> deps.txt
         fi
         if [ "{dependencies}" != "" ]; then
             echo "$(IFS=', '; for dep in `echo {dependencies}`; do echo mediawiki/extensions/$dep; done;)" >> deps.txt
         fi
     - zuul-cloner:
         projects: >
             $(cat deps.txt)
     - ve-submodules-update

# ALWAYS pair with 'mw-teardown-mysql'
- builder:
    name: prepare-mediawiki
    builders:
     - zuul-cloner-extdeps:
         ext-name: '{ext-name}'
         dependencies: '{dependencies}'
         additional-repositories: 'mediawiki/vendor'
     - mw-install-mysql
     - shell: "cp deps.txt src/extensions_load.txt"
     - mw-apply-settings
     - mw-run-update-script

# Workaround zuul-cloner not processing submodules
- builder:
    name: ve-submodules-update
    builders:
     - shell: |
         if grep -q mediawiki/extensions/VisualEditor deps.txt; then
            cd src/extensions/VisualEditor
            git submodule update --init
            git submodule status
            git submodule foreach git clean -xdff -q
         fi

# ALWAYS pair with 'mw-teardown-mysql'
# Similar to prepare-mediawiki, except gets
# the extension name from $ZUUL_PROJECT
- builder:
    name: prepare-mediawiki-zuul-project
    builders:
     - shell: "echo $ZUUL_PROJECT > extensions_load.txt"
     - shell: "echo -e $EXT_DEPENDENCIES >> extensions_load.txt"
     - zuul-cloner:
         projects: >
             mediawiki/core
             mediawiki/vendor
             $(cat extensions_load.txt)
     - shell: "mv extensions_load.txt src/extensions_load.txt"
     - shell: |
         if grep -q mediawiki/extensions/VisualEditor src/extensions_load.txt; then
            cd src/extensions/VisualEditor
            git submodule update --init
         fi
     - mw-install-mysql
     - mw-apply-settings
     - mw-run-update-script
# same except for use with composer instead of cloning vendor
- builder:
    name: prepare-mediawiki-zuul-project-no-vendor
    builders:
     - shell: "echo $ZUUL_PROJECT > extensions_load.txt"
     - shell: "echo -e $EXT_DEPENDENCIES >> extensions_load.txt"
     - zuul-cloner:
         projects: >
             mediawiki/core
             $(cat extensions_load.txt)
     - shell: "mv extensions_load.txt src/extensions_load.txt"
     - shell: |
         if grep -q mediawiki/extensions/VisualEditor src/extensions_load.txt; then
            cd src/extensions/VisualEditor
            git submodule update --init
         fi
     - composer-validate:
         dir: 'src'
     - composer-local-create:
         deps: 'extensions_load.txt'
     - composer-update:
         dir: 'src'
     - mw-install-mysql
     - mw-apply-settings
     - mw-run-update-script

# Generic qunit job for extensions.
- job:
    name: 'mwext-qunit'
    node: contintLabsSlave && UbuntuTrusty
    concurrent: true
    triggers:
     - zuul
    builders:
     - prepare-mediawiki-zuul-project
     - qunit-karma
    publishers:
     - localhost-cleanup
     - mw-teardown-mysql
     - archive-log-dir

# Generic qunit job for extensions with composer update.
- job:
    name: 'mwext-qunit-composer'
    node: contintLabsSlave && UbuntuTrusty
    concurrent: true
    triggers:
     - zuul
    builders:
     - prepare-mediawiki-zuul-project-no-vendor
     - qunit-karma
    publishers:
     - localhost-cleanup
     - mw-teardown-mysql
     - archive-log-dir

# Generic mw-selenium job for extensions.
- job:
    name: 'mwext-mw-selenium'
    node: contintLabsSlave && UbuntuTrusty
    concurrent: true
    triggers:
     - zuul
    builders:
     - prepare-mediawiki-zuul-project
     - zuul-cloner:
         projects: mediawiki/skins/Vector
     - mw-selenium
    publishers:
     - mw-selenium-cleanup
     - localhost-cleanup
     - mw-teardown-mysql
     - archive-log-dir
    logrotate:
      daysToKeep: 15
      artifactDaysToKeep: 3

# Generic mw-selenium job for extensions.
- job:
    name: 'mwext-mw-selenium-composer'
    node: contintLabsSlave && UbuntuTrusty
    concurrent: true
    triggers:
     - zuul
    builders:
     - prepare-mediawiki-zuul-project-no-vendor
     - zuul-cloner:
         projects: mediawiki/skins/Vector
     - mw-selenium
    publishers:
     - mw-selenium-cleanup
     - localhost-cleanup
     - mw-teardown-mysql
     - archive-log-dir
    logrotate:
      daysToKeep: 15
      artifactDaysToKeep: 3

- job-template:
    name: 'mwext-{name}-whitespaces'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    concurrent: true
    logrotate:
        daysToKeep: 15
    triggers:
     - zuul
    builders:
     - lint-whitespaces

# Run extension tests via Zuul cloner
#
- job-template:
    name: '{name}-{ext-name}-testextension-{phpflavor}'
    # See mediawiki.yaml mediawiki-phpunit-{phpflavor}
    node: 'contintLabsSlave && phpflavor-{phpflavor}'
    concurrent: true
    properties:
     - throttle-one-per-node
    triggers:
     - zuul
    builders:
     - assert-phpflavor:
         phpflavor: '{phpflavor}'
     - hhvm-clear-hhbc
     - prepare-mediawiki:
         ext-name: '{ext-name}'
         dependencies: '{dependencies}'
     - mw-fetch-composer-dev
     - mw-run-phpunit-allexts
    # TODO, find ways to additionaly run tests for core but
    # without extensions tests
    publishers:
     - junit:
        results: 'log/junit*.xml'
     - mw-teardown-mysql
     - archive-log-dir

# Generic phpunit job for extensions.
- job-template:
    name: 'mwext-testextension-{phpflavor}'
    node: 'contintLabsSlave && phpflavor-{phpflavor}'
    concurrent: true
    triggers:
     - zuul
    builders:
     - assert-phpflavor:
         phpflavor: '{phpflavor}'
     - hhvm-clear-hhbc
     - prepare-mediawiki-zuul-project
     - mw-fetch-composer-dev
     - mw-run-phpunit-allexts
    publishers:
     - junit:
        results: 'log/junit*.xml'
     - mw-teardown-mysql
     - archive-log-dir

# Same as above, but with non-voting suffix because it's non-voting
- job-template:
    name: 'mwext-testextension-{phpflavor}-non-voting'
    node: 'contintLabsSlave && phpflavor-{phpflavor}'
    concurrent: true
    triggers:
     - zuul
    builders:
     - assert-phpflavor:
         phpflavor: '{phpflavor}'
     - hhvm-clear-hhbc
     - prepare-mediawiki-zuul-project
     - mw-fetch-composer-dev
     - mw-run-phpunit-allexts
    publishers:
     - junit:
        results: 'log/junit*.xml'
     - mw-teardown-mysql
     - archive-log-dir


# same but with composer update instead of cloning vendor
- job-template:
    name: 'mwext-testextension-{phpflavor}-composer'
    node: 'contintLabsSlave && phpflavor-{phpflavor}'
    concurrent: true
    triggers:
     - zuul
    builders:
     - assert-phpflavor:
         phpflavor: '{phpflavor}'
     - hhvm-clear-hhbc
     - prepare-mediawiki-zuul-project-no-vendor
     - mw-run-phpunit-allexts
    publishers:
     - junit:
        results: 'log/junit*.xml'
     - mw-teardown-mysql
     - archive-log-dir

- project:
    name: 'mwext-testextension-generic'
    jobs:
     - 'mwext-testextension-{phpflavor}':
        phpflavor:
            - hhvm
            - php53
            - php55
     - 'mwext-testextension-{phpflavor}-non-voting':
        phpflavor:
            - hhvm
            - php53
            - php55
     - 'mwext-testextension-{phpflavor}-composer':
        phpflavor:
            - hhvm
            - php53
            - php55

- job:
    name: 'mwext-jsduck-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - jsduck
     - doc-publish:
        docsrc: 'docs'
        docdest: '$DOC_BASENAME/$ZUUL_BRANCH/js'

- job-template:
    name: 'mwext-PoolCounter-build'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    triggers:
     - zuul
    builders:
     - shell: |
        cd daemon
        make

- job:
    name: 'mwext-VisualEditor-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    concurrent: false
    triggers:
     - zuul
    builders:
     - npm-install
     - npm-run-doc
     - doc-publish:
        docsrc: 'docs'
        docdest: 'VisualEditor/$ZUUL_BRANCH'
    publishers:
     - global-teardown

- job:
    name: 'mwext-MobileFrontend-doxygen-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - global-setup
     - doxygen
     - doc-publish:
        docsrc: 'docs/php'
        docdest: 'MobileFrontend/$DOC_SUBPATH/php'
    publishers:
     - global-teardown

- job-template:
    name: 'mwext-VisualEditor-sync-gerrit'  # bug 49846
    node: gallium  # needs 'jenkins' user which has the 'jenkins-bot' SSH credentials
    concurrent: false
    logrotate:
        daysToKeep: 30
    triggers:
     - zuul
    builders:
     - shell: /srv/deployment/integration/slave-scripts/bin/gerrit-sync-ve.sh
     - shell: sudo -u jenkins /srv/deployment/integration/slave-scripts/bin/gerrit-sync-ve-push.sh

- project:
    name: mwext

    # By default we do not need any other extensions:
    dependencies: ""

    ext-name:
     - Flow:
        dependencies: 'AbuseFilter,SpamBlacklist,CheckUser,Echo,EventLogging,ConfirmEdit,VisualEditor,GuidedTour'
     - Thanks:
        dependencies: 'Echo,Flow,MobileFrontend,VisualEditor,GuidedTour,AbuseFilter,SpamBlacklist,CheckUser,EventLogging,ConfirmEdit'
     - VisualEditor

    jobs:
     - '{name}-{ext-name}-testextension-{phpflavor}':
         phpflavor:
             - hhvm
             - php53
             - php55

     - '{name}-{ext-name}-npm':
        ext-name: VisualEditor

- project:
    name: 'mwext-CirrusSearch'
    jobs:
     - 'mwext-{name}-whitespaces':
        name: CirrusSearch

- project:
    name: 'mwext-PoolCounter'
    jobs:
     - 'mwext-PoolCounter-build'

- project:
    name: 'mwext-VisualEditor'
    jobs:
     - '{name}-jsduck'
     - 'mwext-VisualEditor-sync-gerrit'

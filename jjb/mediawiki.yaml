# This file holds the configuration for all MediaWiki core related jobs.

# Note that mediawiki/core branches may have a lot of submodules, we thus
# usually need to NOT process submodules (eg: zuul-cloner).
# See https://phabricator.wikimedia.org/T44455

- job:
    name: 'mediawiki-core-jsduck-docker-publish'
    node: DebianJessieDocker
    concurrent: false
    properties:
        - build-discarder:
            days-to-keep: 15
    triggers:
        - zuul
    builders:
        - assert-env-doc_subpath
        - docker-castor-load
        - docker-log-dir
        - docker-src-dir
        - docker-ci-src-setup-simple
        - docker-run-with-log-cache-src:
            image: docker-registry.wikimedia.org/releng/npm-test:0.3.0
            run_args: 'doc'
            logdir: '/log'
        - doc-publish:
           docsrc: 'src/docs/js'
           docdest: 'mediawiki-core/$DOC_SUBPATH/js'
    publishers:
        - archive-log-allow-empty
        - castor-save-workspace-cache
        - postbuild-wipe-src

- job:
    name: 'mediawiki-core-doxygen-docker'
    node: DebianJessieDocker
    # We dont want to overload CI when multiple branches have been updated
    concurrent: false
    triggers:
        - pollscm:
            cron: '@hourly'
    scm:
        - git:
            url: 'https://gerrit.wikimedia.org/r/p/mediawiki/core.git'
            do-not-fetch-tags: true
            branches:
                - :^origin/master
                - :^origin/REL\d+_\d+
            clean:
                before: true
                after: true
            basedir: src
            # Checkout to a local branch with 'origin/' stripped. That also set
            # GIT_LOCAL_BRANCH which we use later to publish the documentation.
            local-branch: '**'
    builders:
        - docker-log-dir
        - shell: |
            install -d -m 777 log/build/
        - shell: |
            rm -fR src/vendor && mkdir -p src/vendor
            git clone \
                --depth 1 \
                --reference /srv/git/mediawiki/vendor.git \
                --branch "$GIT_LOCAL_BRANCH" \
                -- \
                https://gerrit.wikimedia.org/r/p/mediawiki/vendor.git \
                src/vendor
        - shell: |
            touch src/LocalSettings.php
        - docker-run-with-log-cache-src:
            image: docker-registry.wikimedia.org/releng/doxygen:0.4.1
            docker_run_options: '--workdir /src --entrypoint=/usr/bin/php'
            logdir: '/log'
            run_args: |
                maintenance/mwdocgen.php \
                    --no-extensions \
                    --output /log/build \
                    --version "$GIT_LOCAL_BRANCH" \
                    1> >(tee console.txt) \
                    2> >(tee errors.txt >&2)
            # IO redirections happen on the host.
            #
            # stderr is sent as stdin to a tee FIFO which write back to stderr
            # allowing to display and capture stderr.
        - shell: |
            # We want stdout/stderr published on doc.wikimedia.org
            install -m 666 console.txt log/build/
            install -m 666 errors.txt log/build/
        - doc-publish:
            docsrc: 'log/build/html'
            docdest: 'mediawiki-core/${GIT_LOCAL_BRANCH}/php'
        - docker-wipe-dir:
            dir: log/build
    publishers:
        - archive:
            artifacts: 'console.txt,errors.txt'
            allow-empty: true
        - beta-irc  # Spam #wikimedia-releng on failure

- builder:
    name: assert-no-mediawiki-errors
    builders:
        - shell:
            !include-raw:
                - assert-no-mediawiki-errors.bash

- project:
    name: mediawiki-core
    phpflavor:
        - hhvm
        - php55
    jobs:
      - '{name}-jsduck-docker'
      - '{name}-{phpflavor}lint':
          phpflavor:
              - php55
              - php70
              - hhvm

# Used to decouple MediaWiki related projects from the rest of the projects in
# gate-and-submit. See T107529.
- project:
    name: 'mwgate'
    jobs:
        - '{name}-composer-package-{phpflavor}-docker': &phpflavor_docker
            phpflavor:
                - hhvm:
                    image: docker-registry.wikimedia.org/releng/composer-package-hhvm:0.2.4
                - php55:
                    image: docker-registry.wikimedia.org/releng/composer-package-php55:0.2.4
                - php70:
                    image: docker-registry.wikimedia.org/releng/composer-package:0.1.3
        - '{name}-composer-{phpflavor}-docker':
            phpflavor:
                - hhvm:
                    image: docker-registry.wikimedia.org/releng/composer-test-hhvm:0.2.5
                - php55:
                    image: docker-registry.wikimedia.org/releng/composer-test-php55:0.2.5
                - php70:
                    image: docker-registry.wikimedia.org/releng/composer-test:0.1.5
        - '{name}-composer-validate'
        - '{name}-jsduck-docker'
        - '{name}-{phpflavor}lint':
            phpflavor:
                - php55
                - php56
                - php70
        - '{name}-rake-docker'
        - '{name}-tox-docker'
        - '{name}-npm-node-6-docker'
        - '{name}-npm-browser-node-6-docker'

# Phan! (T132636)
- job:
    name: 'mediawiki-core-php70-phan-docker'
    node: DebianJessieDocker && m4executor
    concurrent: true
    properties:
     - build-discarder:
         days-to-keep: 15
    triggers:
     - zuul
    builders:
     - docker-log-dir
     - docker-src-dir
     - docker-tmp-dir
     - docker-cache-dir
     - shell: |
        #!/bin/bash -eu
        set -x
        exec docker run \
            --rm \
            --env-file <(/usr/bin/env|egrep -v '^(HOME|SHELL|PATH|LOGNAME|MAIL|HHVM_REPO_CENTRAL_PATH)=') \
            --volume "$(pwd)"/src:/src \
            --volume "$(pwd)"/cache:/cache \
            --volume "$(pwd)"/tmp:/tmp \
            --volume /srv/git:/srv/git \
            --entrypoint "bash" \
            docker-registry.wikimedia.org/releng/ci-src-setup:0.2.8 \
            /srv/setup-mw.sh
        # nothing else can be executed due to exec
     - shell: |
        exec docker run \
            --rm \
            --volume "$(pwd)"/src:/mediawiki \
            docker-registry.wikimedia.org/releng/mediawiki-phan:0.1.4 \
            -m checkstyle
        # nothing else can be executed due to exec

    publishers:
     - castor-save
     - checkstyle:
        pattern: 'src/tests/phan/issues/latest'
        can-run-on-failed: true
        thresholds:
          failed:
            total-all: 1
     - postbuild-wipe-src

- job-template: &job_quibble
    name: quibble-{packages-source}-{database}-{php}-docker
    node: DebianJessieDocker && m4executor
    quibble_args: ''
    concurrent: true
    triggers:
        - zuul
    builders:
        - docker-castor-load
        - docker-log-dir
        - docker-run-with-log-and-workspace-cache:
            image: '{docker_image}'
            docker_run_options: '--volume /srv/git:/srv/git:ro'
            run_args: '--log-dir /log --packages-source "{packages-source}" --db "{database}" {quibble_args}'
            logdir: '/log'
    publishers:
        - archive-log-allow-empty
        - castor-save-workspace-cache
        - postbuild-wipe-src
    wrappers:
        - timeout:
            timeout: 45  # npm is broken T198348
            fail: true
        - timestamps
        - ansicolor

# Skipping selenium tests - T196960
- job-template:
    !!merge : *job_quibble
    name: quibble-{packages-source}-{database}-{php}-noselenium-docker
    quibble_args: '--skip selenium'
    triggers:
        - zuul

# For the REL branches
- job-template:
    !!merge : *job_quibble
    name: release-quibble-{packages-source}-{database}-{php}-docker
    triggers:
        - zuul

# For the master and wmf/* branches
- job-template:
    !!merge : *job_quibble
    name: wmf-quibble-vendor-mysql-{php}-docker
    # We do not run mediawiki/core tests with extensions installed
    # https://phabricator.wikimedia.org/T197469#4293142
    quibble_args: '--phpunit-testsuite=extensions'
    triggers:
        - zuul

# HACK: Don't run composer test for mediawiki/core, it's
# already run in a separate job
- job-template:
    !!merge : *job_quibble
    name: wmf-quibble-core-vendor-mysql-{php}-docker
    # We do not run mediawiki/core tests with extensions installed
    # https://phabricator.wikimedia.org/T197469#4293142
    quibble_args: '--phpunit-testsuite=extensions --skip composer-test'
    triggers:
        - zuul


- job-template:
    name: mediawiki-quibble-{packages-source}-{database}-{php}-docker
    node: DebianJessieDocker && m4executor
    concurrent: true
    triggers:
        - zuul
    builders:
        - docker-castor-load
        - docker-log-dir
        - docker-run-with-log-and-workspace-cache:
            image: '{docker_image}'
            docker_run_options: '--volume /srv/git:/srv/git:ro'
            run_args: '--log-dir /log --packages-source "{packages-source}" --db "{database}" --skip composer-test'
            logdir: '/log'
    publishers:
        - archive-log-allow-empty
        - castor-save-workspace-cache
        - conditional-publisher:
            - condition-kind: shell
              condition-command: '
                [ $JOB_NAME = "mediawiki-quibble-vendor-mysql-hhvm-docker" ] &&
                [ $ZUUL_PROJECT = "mediawiki/core" ] &&
                [ $ZUUL_BRANCH = "master" ]'
              action:
                - record-node-stats
        - postbuild-wipe-src
    wrappers:
        - timeout:
            timeout: 45  # npm is broken T198348
            fail: true
        - timestamps
        - ansicolor

- job-template:
    name: mediawiki-quibble-composertest-{php}-docker
    node: DebianJessieDocker && m4executor
    concurrent: true
    triggers:
        - zuul
    builders:
        - docker-castor-load
        - docker-log-dir
        - docker-run-with-log-and-workspace-cache:
            image: '{docker_image}'
            docker_run_options: '--volume /srv/git:/srv/git:ro'
            run_args: '--log-dir /log --packages-source "vendor" --db "mysql" --run composer-test'
            logdir: '/log'
    publishers:
        - archive-log-allow-empty
        - castor-save-workspace-cache
        - postbuild-wipe-src
    wrappers:
        - timeout:
            timeout: 45  # npm is broken T198348
            fail: true
        - timestamps
        - ansicolor

# Per-patch coverage for MediaWiki core.
- job-template:
    !!merge : *job_quibble
    name: 'mediawiki-phpunit-coverage-patch-docker'
    quibble_args: '--run=phpunit'
    triggers:
        - zuul
    builders:
        - docker-castor-load
        - docker-log-dir
        - docker-run-with-log-and-workspace-cache:
            image: '{docker_image}'
            docker_run_options: '--volume /srv/git:/srv/git:ro'
            run_args: '--log-dir /log --packages-source {packages-source} --db {database} --commands "phpunit-patch-coverage check --command \"php7.0 -d zend_extension=xdebug.so tests/phpunit/phpunit.php\" --html /log/coverage.html"'
            logdir: '/log'
    publishers:
     - archive:
         artifacts: 'log/coverage.html'
         allow-empty: true
     - postbuild-wipe-src
    wrappers:
     - timeout:
         timeout: 60
         fail: true
     - ansicolor
     - timestamps

- job-template:
    !!merge : *job_quibble
    name: 'mwext-phpunit-coverage-patch-docker'
    quibble_args: '--commands=mwext-phpunit-coverage-patch'
    triggers:
        - zuul

# XXX copy pasted to pass --volume cover:/workspace/cover
- job-template:
    !!merge : *job_quibble
    name: 'mwext-phpunit-coverage-docker-publish'
    quibble_args: '--commands=mwext-phpunit-coverage'
    triggers:
        - zuul
    builders:
        - docker-castor-load
        - docker-wipe-dir:
            dir: 'cover'
        - docker-log-dir
        - docker-run-with-log-and-workspace-cache:
            image: '{docker_image}'
            docker_run_options: '--volume /srv/git:/srv/git:ro --volume "$(pwd)"/cover:/workspace/cover'
            run_args: '--log-dir /log --packages-source "{packages-source}" --db "{database}" {quibble_args}'
            logdir: '/log'
    publishers:
        - archive-log-allow-empty
        - castor-save-workspace-cache
        - postbuildscript:
            builders:
                - cover-extensions-publish:
                    src: 'cover'
                    # Should be equivalent to $EXT_NAME
                    dest: '$DOC_BASENAME'
                - docker-wipe-dir:
                    dir: 'cover'
        - postbuild-wipe-src

# XXX copy pasted to pass --volume cover:/workspace/cover and run cover-publish
- job-template:
    !!merge : *job_quibble
    name: 'mediawiki-core-code-coverage-docker'
    concurrent: false
    quibble_args: '--commands=mediawiki-coverage'
    triggers:
     - timed: '0 3,15 * * *'
    wrappers:
     - timeout:
         timeout: 240
         fail: true
     - ansicolor
     - timestamps
    builders:
        - docker-wipe-dir:
            dir: 'cache'
        - docker-wipe-dir:
            dir: 'cover'
        - docker-log-dir
        - docker-run-with-log-and-workspace-cache:
            image: '{docker_image}'
            docker_run_options: '--volume /srv/git:/srv/git:ro --volume "$(pwd)"/cover:/workspace/cover'
            run_args: '--log-dir /log --packages-source "{packages-source}" --db "{database}" {quibble_args}'
            logdir: '/log'
        - cover-publish:
            src: 'cover'
            dest: 'mediawiki-core'
    publishers:
        - archive-log-allow-empty
        - cloverphp:
            xml-location: 'log/clover.xml'
        - beta-irc  # Spam #wikimedia-releng on failure
        - postbuild-wipe-src

- job-template:
    !!merge : *job_quibble
    name: 'mwselenium-quibble-docker'
    quibble_args: '--skip-deps --commands=mwselenium'

- job:
    name: 'quibble-integration'
    project-type: matrix
    execution-strategy:
        sequential: true
    parameters:
        - matrix-combinations:
            name: combo
            description: 'Select matrix combinations'
    axes:
        - axis:
            type: label-expression
            name: label
            values:
                - contint1001
        - axis:
            name: ZUUL_BRANCH
            type: user-defined
            values:
                - master
                - REL1_31
                - REL1_30
                - REL1_29
                - REL1_27
        - axis:
            name: packagessource
            type: user-defined
            values:
                - composer
                - vendor
        - axis:
            name: database
            type: user-defined
            values:
                - mysql
                - sqlite
        - axis:
            name: php
            type: user-defined
            values:
                - php55
                - php70
                - hhvm
    builders:
        - trigger-builds:
            - project: 'quibble-${packagessource}-${database}-${php}-docker'
              block: true
              predefined-parameters: |
                    projectName=quibble-${packagessource}-${database}-${php}-docker
                    ZUUL_URL=https://gerrit.wikimedia.org/r/p
                    ZUUL_PROJECT=mediawiki/core
                    ZUUL_BRANCH=$ZUUL_BRANCH
                    ZUUL_REF=$ZUUL_BRANCH

- project:
    name: quibble-jobs
    packages-source:
        - composer
        - vendor
    database:
        - mysql
        - postgres
        - sqlite
    php:
        - php55:
            docker_image: docker-registry.wikimedia.org/releng/quibble-jessie-php55:0.0.24
        - php70:
            docker_image: docker-registry.wikimedia.org/releng/quibble-stretch:0.0.24-1
        - hhvm:
            docker_image: docker-registry.wikimedia.org/releng/quibble-jessie-hhvm:0.0.24
    jobs:
        - quibble-{packages-source}-{database}-{php}-docker
        - quibble-{packages-source}-{database}-{php}-noselenium-docker
        - mediawiki-quibble-{packages-source}-{database}-{php}-docker
        - mediawiki-quibble-composertest-{php}-docker
        - release-quibble-{packages-source}-{database}-{php}-docker
        - wmf-quibble-vendor-mysql-{php}-docker:
            # We never use composer on wmf cluster
            packages-source: vendor
            # WMF cluster uses MariaDB/MySQL
            database: mysql
        - wmf-quibble-core-vendor-mysql-{php}-docker:
            # We never use composer on wmf cluster
            packages-source: vendor
            # WMF cluster uses MariaDB/MySQL
            database: mysql
        - mediawiki-phpunit-coverage-patch-docker:
            docker_image: docker-registry.wikimedia.org/releng/quibble-stretch:0.0.24-1
            packages-source: vendor
            database: sqlite
        - mwext-phpunit-coverage-patch-docker:
            docker_image: docker-registry.wikimedia.org/releng/quibble-stretch:0.0.24-1
            packages-source:  composer
            database: mysql
        - mwext-phpunit-coverage-docker-publish:
            docker_image: docker-registry.wikimedia.org/releng/quibble-stretch:0.0.24-1
            packages-source:  composer
            database: mysql
        - mediawiki-core-code-coverage-docker:
            docker_image: docker-registry.wikimedia.org/releng/quibble-stretch:0.0.24-1
            packages-source: vendor
            database: sqlite
        - mwselenium-quibble-docker:
            docker_image: docker-registry.wikimedia.org/releng/quibble-stretch-bundle:0.0.24-8
            packages-source: vendor
            database: mysql

# General MW-Selenium job used to dogfood the builder against MW core.
- job-template:
    !!merge : *job_quibble
    name: 'mediawiki-selenium-integration-docker'

- project:
    name: mediawiki-selenium-integration
    jobs:
        - mediawiki-selenium-integration-docker:
            docker_image: docker-registry.wikimedia.org/releng/quibble-stretch-bundle:0.0.24-8
            packages-source: vendor
            database: mysql
            quibble_args: '--skip-deps --commands=mwselenium -- mediawiki/selenium'

- job-template:
    !!merge : *job_quibble
    name: parsoidsvc-parsertests-docker
    node: DebianJessieDocker
    concurrent: true
    wrappers:
        - timeout:
            timeout: 10  # minutes
            fail: true
        - timestamps
        - ansicolor
    triggers:
        - zuul

- project:
    name: parsoidsvc-parsertests
    jobs:
        - parsoidsvc-parsertests-docker:
            docker_image: docker-registry.wikimedia.org/releng/quibble-jessie-hhvm:0.0.24
            packages-source: composer
            database: sqlite
            quibble_args: '--commands=mediawiki/services/parsoid/tools/ci-mw-parsertests.sh'

- project:
    name: mediawiki-wdio-selenium
    project: MediaWiki
    recipients: zfilipin@wikimedia.org qa-alerts@lists.wikimedia.org betacluster-alerts@list.wikimedia.org
    repository: mediawiki/core
    jobs:
        - 'selenium-daily-beta-{project}'

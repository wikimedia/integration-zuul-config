- builder:
    name: bundle
    builders:
     - shell: |
         # Source any given initialization script
         if [ -x '{initialization}' ]; then
           . '{initialization}'
         fi

         # Shared cache of gems to avoid hitting rubygems all the time
         # See https://github.com/bundler/bundler/issues/2856
         export GEM_HOME="$WORKSPACE/../gems/2.0.0"

         # Install bundler
         if [ '{bundler-version}' != '' ]; then
           version=(-v '{bundler-version}')
         else
           version=()
         fi

         # Change to the given working directory
         cd '{dir}'

         mkdir -p vendor
         gem2.0 install --env-shebang -i vendor --no-document "${{version[@]}}" bundler

         # Prepare some paths lookup
         export GEM_PATH="`pwd`/vendor"

         # Install dependencies
         vendor/bin/bundle install --verbose
         vendor/bin/bundle exec {command}

# Deprecated non-generic job. See below.
- job-template:
    name: '{name}-bundle-{bundlecommand}'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-no-submodules
    concurrent: true
    triggers:
     - zuul
    builders:
     - bundle:
         initialization: ''
         command: "{bundlecommand}"
         dir: '.'
         bundler-version: ''

# Generic bundle job-template.
- job-template:
    name: 'bundle-{bundlecommand}'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: true
    triggers:
     - zuul
    builders:
     - bundle:
         initialization: ''
         command: "{bundlecommand}"
         dir: '.'
         bundler-version: ''

- project:
    name: common-bundle-jobs
    bundlecommand:
     - rspec
     - rubocop
     - yard
    jobs:
     - 'bundle-{bundlecommand}'


- job-template:
    name: 'bundle17-{bundlecommand}'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-no-submodules
    concurrent: true
    triggers:
     - zuul
    builders:
     - bundle:
         initialization: ''
         command: "{bundlecommand}"
         dir: '.'
         bundler-version: '< 1.8.0'

- project:
    name: common-bundle17-jobs
    bundlecommand:
     - cucumber
     - rspec
     - rubocop
    jobs:
     - 'bundle17-{bundlecommand}'

# Call bundle 'yard' to generate documentation in labs and publish to
# doc.wikimedia.org using an intermediate rsync repository in labs.
- job-template:
    name: '{name}-bundle-yard-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul
    triggers:
     - zuul
    builders:
     - bundle:
         initialization: ''
         command: 'yard'
         dir: '.'
         bundler-version: ''
     - doc-publish:
         docsrc: 'doc'
         docdest: 'rubygems/{name}'

- job-template:
    name: '{name}-bundle17-yard-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul
    triggers:
     - zuul
    builders:
     - bundle:
         initialization: ''
         command: 'yard'
         dir: '.'
         bundler-version: '< 1.8.0'
     - doc-publish:
         docsrc: 'doc'
         docdest: 'rubygems/{name}'

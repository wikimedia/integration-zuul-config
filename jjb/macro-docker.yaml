- builder:
    name: zuul-cloner-docker
    builders:
        - shell: |
            docker run \
                --rm --tty \
                --volume "$(pwd)"/src:/src \
                --volume /srv/git:/srv/git \
                wmfreleng/zuul-cloner:v2017.09.26.16.09 \
                --color \
                --verbose \
                --map /zuul-clonemap.yaml \
                --workspace /src \
                --cache-dir /srv/git \
                https://gerrit.wikimedia.org/r/p \
                {projects}

# Build a .env file with ZUUL environment
# variables for use with docker
- builder:
    name: docker-zuul-env
    builders:
     - shell: |
        #!/bin/bash -eu

        set -x

        rm -rf .env

        cat <<ZUUL > .env
        ZUUL_URL=$ZUUL_URL
        ZUUL_PROJECT=$ZUUL_PROJECT
        ZUUL_COMMIT=$ZUUL_COMMIT
        ZUUL_REF=$ZUUL_REF
        ZUUL_BRANCH=$ZUUL_BRANCH
        ZUUL_CHANGES=$ZUUL_CHANGES
        ZUUL_CHANGE_IDS=$ZUUL_CHANGE_IDS
        ZUUL_CHANGE=$ZUUL_CHANGE
        ZUUL_PATCHSET=$ZUUL_PATCHSET
        ZUUL_VOTING=$ZUUL_VOTING
        ZUUL_PIPELINE=$ZUUL_PIPELINE
        ZUUL_UUID=$ZUUL_UUID
        EXT_NAME=$EXT_NAME
        SKIN_NAME=$SKIN_NAME
        EXT_DEPENDENCIES=$EXT_DEPENDENCIES
        SKIN_DEPENDENCIES=$SKIN_DEPENDENCIES
        ZUUL

        # Finally, output for debugging help
        cat .env

# Create a log directory that will be
# mounted into a container with --volume
- builder:
    name: docker-log-dir
    builders:
     - shell: |
        rm -rf log
        mkdir -m 2777 -p "log"

# Create a src directory that will be
# mounted into a container with --volume
- builder:
    name: docker-src-dir
    builders:
     - shell: |
        rm -rf src
        mkdir -m 2777 -p "src"

# Create a cache directory that will be
# mounted into a container with --volume
- builder:
    name: docker-cache-dir
    builders:
     - shell: |
        mkdir -m 2777 -p "cache"

# Run a docker image with .env and a log
- builder:
    name: docker-run-with-log
    builders:
     - shell: |
        #!/bin/bash -eu
        set -x
        docker run \
            --rm --tty \
            --env-file .env \
            --volume "$(pwd)"/log:{logdir} \
            {image}

# Run a docker image with .env and a log and cache directory
- builder:
    name: docker-run-with-log-and-workspace-cache
    builders:
     - shell: |
        #!/bin/bash -eu
        set -x
        docker run \
            --rm --tty \
            --env-file .env \
            --volume "$(pwd)"/log:{logdir} \
            --volume "$(pwd)"/cache:/cache \
            {image}

# Run a docker image with cache, log, and src directories
- builder:
    name: docker-run-with-log-cache-src
    builders:
     - shell: |
        #!/bin/bash -eu
        set -x
        chmod 2777 src
        docker run \
            --rm --tty \
            --volume "$(pwd)"/log:{logdir} \
            --volume "$(pwd)"/cache:/cache \
            --volume "$(pwd)"/src:/src \
            {image}

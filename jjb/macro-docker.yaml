# Create a log directory that will be
# mounted into a container with --volume
- builder:
    name: docker-log-dir
    builders:
     - docker-wipe-dir:
         dir: log

# Delete everything in $WORKSPACE. This should generally be used as the final
# publisher for all Docker based jobs.
- publisher:
    name: docker-wipe-workspace
    publishers:
     # Run via Docker as root to have sufficient permission to delete files of
     # any owner within the workspace directory and use `find` which more
     # handily processes dotfiles. Then delete the workspace directory itself.
     - postbuildscript:
         script-only-if-succeeded: false
         script-only-if-failed: false
         builders:
          - shell: |
              set -eux
              docker run \
                  --rm \
                  --user=root \
                  -v "$WORKSPACE":/workspace \
                  --entrypoint=/usr/bin/find \
                  docker-registry.wikimedia.org/wikimedia-stretch:latest \
                  "/workspace" -mindepth 1 -delete
              rmdir "$WORKSPACE"

# Create a src directory that will be
# mounted into a container with --volume
- builder:
    name: docker-src-dir
    builders:
     - docker-wipe-dir:
         dir: src

# Create a tmp directory that will be
# mounted into a container with --volume
- builder:
    name: docker-tmp-dir
    builders:
     - shell: mkdir -m 1777 -p tmp
     - docker-wipe-dir:
         dir: tmp

# Delete content of a directory under $WORKSPACE as 'nobody'
- builder:
    name: docker-wipe-dir
    builders:
     - shell: |
         set -eux
         mkdir -m 2777 -p "{dir}"
         docker run \
             --rm \
             --user=nobody \
             -v "$WORKSPACE":/workspace \
             --entrypoint=/usr/bin/find \
             docker-registry.wikimedia.org/wikimedia-stretch:latest \
             "/workspace/{dir}" -mindepth 1 -delete

# Create a cache directory that will be
# mounted into a container with --volume
- builder:
    name: docker-cache-dir
    builders:
     - shell: |
        mkdir -m 2777 -p "cache"

# Run a docker image with .env and a log
- builder:
    name: docker-run-with-log
    builders:
     - docker-tmp-dir
     - shell: |
        #!/bin/bash -eu
        set -x
        exec docker run \
            {obj:docker_run_options|} \
            --rm \
            --env-file <(/usr/bin/env|egrep -v '^(HOME|SHELL|PATH|LOGNAME|MAIL|HHVM_REPO_CENTRAL_PATH)=') \
            --volume "$(pwd)"/log:{logdir} \
            --volume "$(pwd)"/tmp:/tmp \
            {image}
        # nothing else can be executed due to exec

# Run a docker image with .env and a log and cache directory
#
# Parameters:
#
# image: the Docker image to run (eg: releng/php)
# run_args (optional): arguments passed to `docker run`.
- builder:
    name: docker-run-with-log-and-workspace-cache
    builders:
     - docker-tmp-dir
     - shell: |
        #!/bin/bash -eu
        set -x
        exec docker run \
            {obj:docker_run_options|} \
            --rm \
            --env-file <(/usr/bin/env|egrep -v '^(HOME|SHELL|PATH|LOGNAME|MAIL|HHVM_REPO_CENTRAL_PATH)=') \
            --volume "$(pwd)"/log:{logdir} \
            --volume "$(pwd)"/cache:/cache \
            --volume "$(pwd)"/tmp:/tmp \
            {image} {obj:run_args|}
        # nothing else can be executed due to exec

# Run a docker image with cache, log, and src directories
#
# Parameter:
#
# image: the Docker image to run (eg: releng/php)
# run_args (optional): arguments passed to `docker run`.
- builder:
    name: docker-run-with-log-cache-src
    builders:
     - docker-tmp-dir
     - shell: |
        #!/bin/bash -eu
        set -x
        chmod 2777 src
        exec docker run \
            {obj:docker_run_options|} \
            --rm \
            --env-file <(/usr/bin/env|egrep -v '^(HOME|SHELL|PATH|LOGNAME|MAIL|HHVM_REPO_CENTRAL_PATH)=') \
            --volume "$(pwd)"/log:{logdir} \
            --volume "$(pwd)"/cache:/cache \
            --volume "$(pwd)"/src:/src \
            --volume "$(pwd)"/tmp:/tmp \
            {image} {obj:run_args|}
        # nothing else can be executed due to exec

# Use a docker image to clone for a MediaWiki extension or skin
- builder:
    name: docker-ci-src-setup-mwext
    builders:
     - docker-tmp-dir
     - shell: |
        #!/bin/bash -eu
        set -x
        exec docker run \
            --rm \
            --env-file <(/usr/bin/env|egrep -v '^(HOME|SHELL|PATH|LOGNAME|MAIL|HHVM_REPO_CENTRAL_PATH)=') \
            --volume "$(pwd)"/src:/src \
            --volume "$(pwd)"/cache:/cache \
            --volume "$(pwd)"/tmp:/tmp \
            --volume /srv/git:/srv/git \
            --entrypoint "bash" \
            docker-registry.wikimedia.org/releng/ci-src-setup:0.2.8 \
            /srv/setup-mwext.sh
        # nothing else can be executed due to exec

# Use a docker image to clone for MediaWiki core
- builder:
    name: docker-ci-src-setup-mw
    builders:
     - docker-tmp-dir
     - shell: |
        #!/bin/bash -eu
        set -x
        exec docker run \
            --rm \
            --env-file <(/usr/bin/env|egrep -v '^(HOME|SHELL|PATH|LOGNAME|MAIL|HHVM_REPO_CENTRAL_PATH)=') \
            --volume "$(pwd)"/src:/src \
            --volume "$(pwd)"/cache:/cache \
            --volume "$(pwd)"/tmp:/tmp \
            --volume /srv/git:/srv/git \
            --entrypoint "bash" \
            docker-registry.wikimedia.org/releng/ci-src-setup:0.2.8 \
            /srv/setup-mw.sh
        # nothing else can be executed due to exec


# Use a docker image to clone the repository into /src
- builder:
    name: docker-ci-src-setup-simple
    builders:
     - docker-tmp-dir
     - shell: |
        #!/bin/bash -eu
        set -x
        exec docker run \
            --rm \
            --env-file <(/usr/bin/env|egrep -v '^(HOME|SHELL|PATH|LOGNAME|MAIL|HHVM_REPO_CENTRAL_PATH)=') \
            --volume "$(pwd)"/src:/src \
            --volume "$(pwd)"/cache:/cache \
            --volume "$(pwd)"/tmp:/tmp \
            --volume /srv/git:/srv/git \
            docker-registry.wikimedia.org/releng/ci-src-setup-simple:0.1.0
        # nothing else can be executed due to exec

- builder:
    name: docker-zuul-cloner
    builders:
     - docker-src-dir
     - docker-tmp-dir
     - shell: |
         #!/bin/bash -eux
         exec docker run \
             --rm \
             --env-file <(/usr/bin/env|egrep -v '^(HOME|SHELL|PATH|LOGNAME|MAIL|HHVM_REPO_CENTRAL_PATH)=') \
             --volume "$(pwd)"/src:/src \
             --volume "$(pwd)"/tmp:/tmp \
             --volume /srv/git:/srv/git:ro \
             docker-registry.wikimedia.org/releng/zuul-cloner:0.1.1 \
                 --color --verbose \
                 --map /zuul-clonemap.yaml \
                 --workspace /src \
                 --cache-dir /srv/git \
                 https://gerrit.wikimedia.org/r/p \
                 {projects}
         # nothing else can be executed due to exec

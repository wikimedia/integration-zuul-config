# Build a .env file with ZUUL environment
# variables for use with docker
- builder:
    name: docker-zuul-env
    builders:
     - shell: |
        #!/bin/bash -e

        set -x

        rm -rf .env

        cat <<ZUUL > .env
        ZUUL_URL=$ZUUL_URL
        ZUUL_PROJECT=$ZUUL_PROJECT
        ZUUL_COMMIT=$ZUUL_COMMIT
        ZUUL_REF=$ZUUL_REF
        ZUUL_BRANCH=$ZUUL_BRANCH
        ZUUL_CHANGES=$ZUUL_CHANGES
        ZUUL_CHANGE_IDS=$ZUUL_CHANGE_IDS
        ZUUL_CHANGE=$ZUUL_CHANGE
        ZUUL_PATCHSET=$ZUUL_PATCHSET
        ZUUL_VOTING=$ZUUL_VOTING
        ZUUL_PIPELINE=$ZUUL_PIPELINE
        ZUUL_UUID=$ZUUL_UUID
        EXT_NAME=$EXT_NAME
        SKIN_NAME=$SKIN_NAME
        EXT_DEPENDENCIES=$EXT_DEPENDENCIES
        SKIN_DEPENDENCIES=$SKIN_DEPENDENCIES
        JENKINS_URL=$JENKINS_URL
        ZUUL

        # Finally, output for debugging help
        cat .env

# Create a log directory that will be
# mounted into a container with --volume
- builder:
    name: docker-log-dir
    builders:
     - shell: |
        rm -rf log
        mkdir -m 2777 -p "log"

# Create a src directory that will be
# mounted into a container with --volume
- builder:
    name: docker-src-dir
    builders:
     - shell: |
        rm -rf src
        mkdir -m 2777 -p "src"

# Create a cache directory that will be
# mounted into a container with --volume
- builder:
    name: docker-cache-dir
    builders:
     - shell: |
        mkdir -m 2777 -p "cache"

# Run a docker image with .env and a log
- builder:
    name: docker-run-with-log
    builders:
     - shell: |
        #!/bin/bash -eu
        set -x
        docker run \
            --rm --tty \
            --env-file .env \
            --volume "$(pwd)"/log:{logdir} \
            {image}

# Run a docker image with .env and a log and cache directory
#
# Parameters:
#
# image: the Docker image to run (eg: wmfreleng/php)
# run_args (optional): arguments passed to `docker run`.
#                      XXX must start with a leading space
- builder:
    name: docker-run-with-log-and-workspace-cache
    builders:
     - shell: |
        #!/bin/bash -eu
        set -x
        docker run \
            --rm --tty \
            --env-file .env \
            --volume "$(pwd)"/log:{logdir} \
            --volume "$(pwd)"/cache:/cache \
            {image}{obj:run_args|}

# Run a docker image with cache, log, and src directories
- builder:
    name: docker-run-with-log-cache-src
    builders:
     - shell: |
        #!/bin/bash -eu
        set -x
        chmod 2777 src
        docker run \
            --rm --tty \
            --volume "$(pwd)"/log:{logdir} \
            --volume "$(pwd)"/cache:/cache \
            --volume "$(pwd)"/src:/src \
            {image}

# Use a docker image to clone for a MediaWiki extension
- builder:
    name: docker-ci-src-setup-mwext
    builders:
     - shell: |
        #!/bin/bash -eu
        set -x
        docker run \
            --rm --tty \
            --env-file .env \
            --volume "$(pwd)"/src:/src \
            --volume "$(pwd)"/cache:/cache \
            --volume /srv/git:/srv/git \
            --entrypoint "bash" \
            wmfreleng/ci-src-setup:v2017.10.17.09.17 \
            /srv/setup-mwext.sh

# Use a docker image to clone the repository into /src
- builder:
    name: docker-ci-src-setup-simple
    builders:
     - shell: |
        #!/bin/bash -eu
        set -x
        docker run \
            --rm --tty \
            --env-file .env \
            --volume "$(pwd)"/src:/src \
            --volume "$(pwd)"/cache:/cache \
            --volume /srv/git:/srv/git \
            wmfreleng/ci-src-setup-simple:v2017.10.28.06.19

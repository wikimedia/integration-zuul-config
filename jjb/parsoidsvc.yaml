# Runs MediaWiki core @master PHP parser tests
- job-template:
    name: parsoidsvc-hhvm-parsertests-jessie
    node: ci-jessie-wikimedia
    concurrent: true
    properties:
        - zeromq-event
    wrappers:
        - timeout:
            timeout: 10  # minutes
            fail: true
        - timestamps
        - ansicolor
    triggers:
        - zuul
    builders:
        - assert-phpflavor:
            phpflavor: 'hhvm'
        - assert-node-version-4.3
        - castor-load
        - zuul-parsoid-cloner:
             projects: >
                mediawiki/core
                mediawiki/services/parsoid
        - composer-update:
            dir: 'src/mediawiki/core'
        - shell: |
            # Install MediaWiki in a different directory
            export MW_INSTALL_PATH='src/mediawiki/core'
            # Keep these consistent with `prepare-mediawiki-zuul-project-no-vendor`
            /srv/deployment/integration/slave-scripts/bin/mw-install-sqlite.sh
            /srv/deployment/integration/slave-scripts/bin/mw-apply-settings.sh
            /srv/deployment/integration/slave-scripts/bin/mw-run-update-script.sh
        - shell: |
           # record the versions of parsertests we're running, for debugging
           # if something goes wrong
           find -name parserTests.txt -print0 | xargs -0 md5sum -b
           # Now run parserTests
           # FIXME should use the phpunit wrapper
           cd src/mediawiki/core
           php tests/parserTests.php --color=no --quiet \
            --file="$WORKSPACE/parsoidsvc/tests/parserTests.txt"
    publishers:
        - archive-log-allow-empty
        - castor-save

- job-template:
    name: parsoidsvc-{repository}-parse-tool-check-trusty
    defaults: use-remoteonly-zuul
    node: ci-trusty-wikimedia
    concurrent: true
    properties:
        - zeromq-event
    wrappers:
        - timeout:
            timeout: 5
            fail: true
        - timestamps
        - ansicolor
    triggers:
        - zuul
    builders:
        - assert-node-version-0.10
        - castor-load
        - setup-npm-oid:
            repository: '{repository}'
        - shell: |
            # If any of these commands fail, something is wrong
            set -e
            . npm-oid.env
            cd "$NPM_SET_PATH"/bin
            echo "Foo" | node parse.js --wt2html
            echo "Foo" | node parse.js --wt2wt
            echo "Foo" | node parse.js --html2wt
            echo "Foo" | node parse.js --html2html
    publishers:
     - castor-save

- job-template:
    name: parsoidsvc-{repository}-roundtrip-test-check-trusty
    defaults: use-remoteonly-zuul
    node: ci-trusty-wikimedia
    concurrent: true
    properties:
        - zeromq-event
    wrappers:
        - timeout:
            timeout: 10
            fail: true
        - timestamps
        - ansicolor
    triggers:
        - zuul
    builders:
        - assert-node-version-0.10
        - castor-load
        - setup-npm-oid:
            repository: '{repository}'
        - shell: |
            # If any of these commands fail, something is wrong
            set -e
            . npm-oid.env
            cd "$NPM_SET_PATH"/bin
            node roundtrip-test.js "Barack Obama"
            node roundtrip-test.js --prefix frwiki "Chope"
            node roundtrip-test.js --xml "Parkour"
    publishers:
     - castor-save

- job-template:
    name: parsoidsvc-{repository}-npm-node-4.3
    node: ci-jessie-wikimedia
    defaults: use-remoteonly-zuul
    concurrent: true
    properties:
        - zeromq-event
    wrappers:
        - timeout:
            timeout: 20
            fail: true
        - timestamps
        - ansicolor
    triggers:
        - zuul
    builders:
    - assert-node-version-4.3
    - castor-load
    - shell: |
        # For archiving build artifacts
        mkdir -p "$WORKSPACE/log"
    - setup-npm-oid:
        repository: '{repository}'
    - shell: |
        node --version
        npm --version
        set -e
        . npm-oid.env
        cd "$NPM_SET_PATH"
        npm test
        npm run doc
    publishers:
     - archive-log-allow-empty
     - castor-save

# Same but with NodeJs 0.10 / Trusty
- job-template:
    name: parsoidsvc-{repository}-npm-node-0.10
    node: ci-trusty-wikimedia
    defaults: use-remoteonly-zuul
    concurrent: true
    properties:
        - zeromq-event
    wrappers:
        - timeout:
            timeout: 20
            fail: true
        - timestamps
        - ansicolor
    triggers:
        - zuul
    builders:
    - assert-node-version-0.10
    - castor-load
    - shell: |
        # For archiving build artifacts
        mkdir -p "$WORKSPACE/log"
    - setup-npm-oid:
        repository: '{repository}'
    - shell: |
        node --version
        npm --version
        set -e
        . npm-oid.env
        cd "$NPM_SET_PATH"
        npm test
        npm run doc
    publishers:
     - archive-log-allow-empty
     - castor-save

# documentation builder (based on `oojs-ui-jsduck-publish` job)
- job-template:
    name: parsoidsvc-{repository}-jsduck-publish
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remoteonly-zuul
    concurrent: false
    triggers:
     - zuul
    builders:
    - assert-node-version-0.10
    - setup-npm-oid:
        repository: '{repository}'
    - shell: |
        node --version
        npm --version
        set -e
        . npm-oid.env
        ln -s "$NPM_SET_PATH/docs" generated-docs
        cd "$NPM_SET_PATH"
        npm run doc
    - doc-publish:
        docsrc: 'generated-docs'
        docdest: 'Parsoid/$DOC_SUBPATH'
    publishers:
    - global-teardown

- project:
    name: parsoidsvc
    # job templates are shared by both repositories
    repository:
     - source  # mediawiki/services/parsoid
     - deploy  # mediawiki/services/parsoid/deploy
    jobs:
        - '{name}-npm-run-{script}-node-4.3':
            script: 'lint'
        - '{name}-debian-glue':
            distribution: trusty
        - 'parsoidsvc-{repository}-parse-tool-check-trusty'
        - 'parsoidsvc-{repository}-roundtrip-test-check-trusty'
        - 'parsoidsvc-{repository}-npm-node-4.3'
        - 'parsoidsvc-{repository}-npm-node-0.10'
        - 'parsoidsvc-{repository}-jsduck-publish'
        - parsoidsvc-hhvm-parsertests-jessie

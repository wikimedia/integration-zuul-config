# CASTOR - CAche STORage
#
# Let us save package manager caches on a central instance and warm a cache
# when a job runs on a Nodepool disposable instance.
#

# Entry point to save to the central cache
- publisher:
    name: castor-save
    publishers:
     - postbuildscript:
         builders:
           - build-on:
              - SUCCESS
             build-steps:
              - trigger-builds:
                  - project: castor-save
                    # Pass ZUUL and others
                    current-parameters: True
                    # Pass:
                    # - job name to namespace the central cache
                    # - ssh connection which holds the slave IP to which castor
                    #   will rsync from
                    predefined-parameters: |
                        TRIGGERED_JOB_NAME=$JOB_NAME
                        TRIGGERED_SSH_CONNECTION=$SSH_CONNECTION
                    # Must be blocking or the instance might be disposed
                    block: true
                    # Ignore any error
                    block-thresholds:
                        build-step-failure-threshold: 'never'
                        unstable-threshold: 'never'
                        failure-threshold: 'never'

- publisher:
    name: castor-save-workspace-cache
    publishers:
     - postbuildscript:
         builders:
           - build-on:
              - SUCCESS
             build-steps:
              - trigger-builds:
                  - project: castor-save-workspace-cache
                    # Pass ZUUL and others
                    current-parameters: True
                    # Pass:
                    # - job name to namespace the central cache
                    # - ssh connection which holds the slave IP to which castor
                    #   will rsync from
                    predefined-parameters: |
                        TRIGGERED_JOB_NAME=$JOB_NAME
                        TRIGGERED_SSH_CONNECTION=$SSH_CONNECTION
                        TRIGGERED_WORKSPACE=$WORKSPACE
                    # Must be blocking or the instance might be disposed
                    block: true
                    # Ignore any error
                    block-thresholds:
                        build-step-failure-threshold: 'never'
                        unstable-threshold: 'never'
                        failure-threshold: 'never'
     # Delete /cache material that just have been saved. Do that inside a
     # container since files are owned by 'nobody'
     - postbuildscript:
         mark-unstable-if-failed: false
         builders:
           - build-on:
                 - SUCCESS
                 - UNSTABLE
                 - FAILURE
                 - ABORTED
             build-steps:
                 - shell: 'echo "Clearing $WORKSPACE/cache"'
                 - docker-run:
                    options: '--volume "$(pwd)"/cache:/cache'
                    image: 'docker-registry.wikimedia.org/releng/castor:0.2.1'
                    args: 'clear || :'

# Entry point to load cache from central cache
#
# Forge the namespace and rsync from central place.
#
# Transfer is done with rsync:// protocol fetching from the 'caches' rsync
# module which is read-only.
#
- builder:
    name: castor-load
    builders:
        - shell:
            !include-raw:
                - castor-define-namespace.bash
                - castor-load-sync.bash

- builder:
    name: docker-castor-load
    builders:
        - docker-cache-dir
        - docker-run:
            options: '--volume "$(pwd)"/cache:/cache'
            image: 'docker-registry.wikimedia.org/releng/castor:0.2.4'
            args: 'load'

# Job triggered on the central repository instance
#
# Rsync from a Jenkins agent using the 'jenkins-deploy' credential.  The ssh key
# is made available via an ssh-agent and injected by Jenkins credentials store.
#
- job:
    name: castor-save-workspace-cache
    node: integration-castor03
    properties:
     - build-discarder:
         days-to-keep: 5
    parameters:
        - string:
            name: TRIGGERED_SSH_CONNECTION
            description: 'SSH_CONNECTION of upstream job (contains IP of remote instance)'
        - string:
            name: TRIGGERED_JOB_NAME
            description: 'JOB_NAME of upstream job'
        - string:
            name: ZUUL_PIPELINE
            description: 'Name of Zuul pipeline. Must be gate-and-submit or postmerge to actually save cache.'
    wrappers:
      - timeout:
          timeout: 1 # minutes
          abort: false
          fail: false
      - timestamps
      - credentials-binding:
          - text:
              credential-id: composer-github-oauthtoken
              variable: COMPOSER_GITHUB_OAUTHTOKEN
      - ssh-agent-credentials:
          users:
             - 'ae711ff4-813e-4462-9a27-21bdbd4fdcb9'  # jenkins-deploy
    builders:
        - shell:
            !include-raw:
                - castor-define-namespace.bash
                - castor-save-workspacecache.bash

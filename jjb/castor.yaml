- publisher:
    name: castor-save
    publishers:
     - postbuildscript:
         script-only-if-succeeded: True
         mark-unstable-if-failed: True
         builders:
          - shell: |
              set -eu +x
              echo "Preparing castor properties"

              # We need to tell castor to which IP address to connect to

              rm -f castor.properties
              ssh_config=($SSH_CONNECTION)
              echo "REMOTE_INSTANCE=${ssh_config[2]}" >> castor.properties

              # Craft a namespaced dir to save cache into

              # Replace slashes with dashes:
              ZUUL_PROJECT=${ZUUL_PROJECT////-}
              ZUUL_BRANCH=${ZUUL_BRANCH////-}
              # Ex: mediawiki-core/REL1_26/tox-jessie
              ns="${ZUUL_PROJECT}/${ZUUL_BRANCH}/${JOB_NAME}"
              echo "CASTOR_NAMESPACE=${ns}" >> castor.properties

              echo "Properties:"
              cat castor.properties
          - trigger-builds:
              - project: castor-save
                property-file: castor.properties
                # Must be blocking or the instance might be disposed
                block: true
                # And ignore any error
                block-thresholds:
                    build-step-failure-threshold: 'never'
                    unstable-threshold: 'never'
                    failure-threshold: 'never'
                                                 
- job:
    name: castor-save
    node: castor
    concurrent: true
    parameters:
        - string:
            name: REMOTE_INSTANCE
            description: 'IP / Hostname of remote instances to ssh into with the Nodepool Jenkins user.'
        - string:
            name: CASTOR_NAMESPACE
            description: 'Namespace for the cache.'
    wrappers:
        - ansicolor
        - timeout:
            timeout: 1  # minutes
            abort: false
            fail: false
        - timestamps
        - ssh-agent-credentials:
            users:
             - 'nodepool-dib-jenkins'

    builders:
        - shell: |
            set -eu +x
            DEST="/mnt/jenkins-workspace/caches/${CASTOR_NAMESPACE}"

            echo "Creating directory holding cache:"
            mkdir -v -p "${DEST}"

            echo "Ensure cache directories exist on remote"
            ssh -q -a -T \
              -o ConnectTimeout=6 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no \
              jenkins@"${REMOTE_INSTANCE}" \
              'mkdir -v -p .cache/pip .npm workspace/vendor/bundle'

            echo "Syncing to ${DEST}"
            rsync \
              --archive \
              --compress \
              --progress \
              --verbose \
              --rsh="ssh -a -T  -o ConnectTimeout=6 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" \
              --delete-delay \
              --relative \
              jenkins@"${REMOTE_INSTANCE}":.cache/pip :.npm :workspace/vendor/bundle "${DEST}/"

            echo -e "Done"

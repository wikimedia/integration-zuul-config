- job-template:
    name: 'operations-dns-lint'
    # Depends on production GeoIP T98737
    # Manual workaround has been applied though
    node: contintLabsSlave && DebianJessie
    defaults: use-remoteonly-zuul
    concurrent: true
    triggers:
     - zuul
    builders:
     - shell: |
         mkdir -p "$WORKSPACE"/build
         # Lint script provided via puppet authdns::lint class
         /usr/local/bin/authdns-lint "$WORKSPACE" "$WORKSPACE"/build

- project:
    name: 'operations-dns'
    jobs:
     - 'operations-dns-lint'
     - '{name}-tabs':
         fileselector: '*'

- project:
    name: 'operations-mw-config'
    jobs:
     - '{name}-php55lint'
     - '{name}-typos'

# Runs 'composer validate' and 'composer test', for the
# operations/mediawiki-config repo. Uses fetch-composer-dev to install require-dev
# packages while preserving non-dev packages from vendor in Git. (T85947)
# Avoid generic jobs to ensure it stays out of the
# MediaWiki gate-and-submit queue. (T101908)
- job:
    name: 'operations-mw-config-composer-hhvm-jessie'
    node: ci-jessie-wikimedia
    defaults: use-remoteonly-zuul
    concurrent: true
    triggers:
     - zuul
    builders:
     - composer-validate:
         dir: '.'
     - fetch-composer-dev
     - composer-test

- job:
    name: 'operations-mw-config-phpunit-2'
    node: ci-jessie-wikimedia
    triggers:
     - zuul
    scm:
     - git:
        url: '$ZUUL_URL/$ZUUL_PROJECT'
        reference-repo: '/srv/git/${ZUUL_PROJECT}.git'
        branches:
         - '$ZUUL_COMMIT'
        refspec: '$ZUUL_REF'
        submodule:
            disable: false
    builders:
     - composer-validate:
         dir: '.'
     - castor-load
     - shell: |
         php --version
         versions_paths=`php -r 'print join("\n", array_unique(json_decode(file_get_contents("wikiversions.json"), true)));'`
         for wmfpath in $versions_paths; do
             git clone -q https://gerrit.wikimedia.org/r/p/mediawiki/core \
                 --reference /srv/git/mediawiki/core.git \
                 --single-branch \
                 --branch "${wmfpath/php-/wmf/}" \
                 "$wmfpath"
             git -C "$wmfpath" branch -vv
             git -C "$wmfpath" submodule update --init \
                 --reference /srv/git/mediawiki/vendor.git vendor
         done;
     - shell: |
         composer install --dev --ansi --prefer-dist -v
     - composer-test
    publishers:
     - phpunit-junit
     - archive-log-dir
     - castor-save

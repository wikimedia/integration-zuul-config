- job-template:
    name: 'operations-dns-lint'
    # Depends on production GeoIP T98737
    # Manual workaround has been applied though
    node: contintLabsSlave && DebianJessie
    defaults: use-remoteonly-zuul
    concurrent: true
    triggers:
     - zuul
    builders:
     - shell: |
         mkdir -p "$WORKSPACE"/build
         # Lint script provided via puppet authdns::lint class
         /usr/local/bin/authdns-lint "$WORKSPACE" "$WORKSPACE"/build

- project:
    name: 'operations-dns'
    jobs:
     - 'operations-dns-lint'
     - '{name}-tabs':
         fileselector: '*'

- project:
    name: 'operations-mw-config'
    jobs:
     - '{name}-php55lint'
     - '{name}-typos'

# Runs 'phpunit' and 'composer validate', for the
# operations/mediawiki-config repo to get it out of
# the MediaWiki gate-and-submit queue (T101908)
- job:
    name: 'operations-mw-config-phpunit'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    triggers:
     - zuul
    builders:
     - composer-validate:
         dir: '.'
     - phpunit-junit
    publishers:
     - phpunit-junit
     - archive-log-dir
    scm:
     # Override to wipe workspace/shallow clone and process submodules
     - git:
        url: '$ZUUL_URL/$ZUUL_PROJECT'
        branches:
         - '$ZUUL_COMMIT'
        refspec: '$ZUUL_REF'
        wipe-workspace: true
        shallow-clone: true
        submodule:
            disable: false

- job:
    name: 'operations-mw-config-phpunit-2'
    node: ci-jessie-wikimedia
    triggers:
     - zuul
    scm:
     - git:
        url: '$ZUUL_URL/$ZUUL_PROJECT'
        reference-repo: '/srv/git/${ZUUL_PROJECT}.git'
        branches:
         - '$ZUUL_COMMIT'
        refspec: '$ZUUL_REF'
        submodule:
            disable: false
    builders:
     - composer-validate:
         dir: '.'
     - shell: |
         php --version
         versions_paths=`php -r 'print join("\n", array_unique(json_decode(file_get_contents("wikiversions.json"), true)));'`
         for wmfpath in $versions_paths; do
             git clone -q https://gerrit.wikimedia.org/r/p/mediawiki/core \
                 --reference /srv/git/mediawiki/core.git \
                 --single-branch \
                 --branch "${wmfpath/php-/wmf/}" \
                 "$wmfpath"
             git -C "$wmfpath" branch -vv
         done;
     - castor-load
     - shell: |
         mkdir -p log
         # xhprof requires mwcrypt which we do not have
         composer require --ignore-platform-reqs -- "phpunit/phpunit=4.8.*"
         composer exec -- phpunit \
             --colors=always \
             --log-junit log/junit-phpunit.xml
    publishers:
     - phpunit-junit
     - archive-log-dir
     - castor-save

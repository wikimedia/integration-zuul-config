
# Publish Doxygen-generated docs to doc.wikimedia.org
# NOTE: Only use this generic job if the desired public directory name
# matches the Git repository name.
- job:
    name: 'doxygen-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - global-setup
     - doxygen
     - doc-publish:
        docsrc: 'doc/html'
        docdest: '$DOC_PROJECT/$DOC_SUBPATH'
    publishers:
     - global-teardown

- job:
    name: 'phpunit-coverage-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - global-setup
     - composer-update:
        dir: '.'
     - phpunit-coverage
     - cover-publish:
        src: 'coverage'
        dest: '$DOC_PROJECT'
    publishers:
     - global-teardown

- job:
    name: 'unicodejs-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - npm-install
     - npm-run-doc
     - doc-publish:
        docsrc: 'docs'
        docdest: 'unicodejs/$DOC_SUBPATH'
    publishers:
     - global-teardown

- job:
    name: 'unicodejs-coverage'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - npm
     - cover-publish:
        src: 'coverage'
        dest: 'unicodejs'
    publishers:
     - global-teardown

- job:
    name: 'oojs-core-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - npm-install
     - npm-run-doc
     - doc-publish:
        docsrc: 'docs'
        docdest: 'oojs/$DOC_SUBPATH'
    publishers:
     - global-teardown

- job:
    name: 'oojs-core-coverage'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - npm
     - cover-publish:
        src: 'coverage'
        dest: 'oojs'
    publishers:
     - global-teardown

- job:
    name: 'oojs-ui-jsduck-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - npm-install
     - npm-run-doc
     - doc-publish:
        docsrc: 'docs'
        docdest: 'oojs-ui/$DOC_SUBPATH/js'
    publishers:
     - global-teardown

- job:
    name: 'oojs-ui-coverage'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - npm
     - cover-publish:
        src: 'coverage'
        dest: 'oojs-ui'
    publishers:
     - global-teardown

- job:
    name: 'oojs-ui-doxygen-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - global-setup
     - doxygen
     - doc-publish:
        docsrc: 'doc/html'
        docdest: 'oojs-ui/$DOC_SUBPATH/php'
    publishers:
     - global-teardown

- job:
    name: 'oojs-ui-demos-publish'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - npm-install
     - npm-run-demos
     - doc-publish:
        docsrc: 'demos'
        docdest: 'oojs-ui/$DOC_SUBPATH/demos'
    publishers:
     - global-teardown

- job:
    name: 'visualeditor-coverage'
    node: contintLabsSlave && UbuntuTrusty
    defaults: use-remote-zuul-shallow-clone
    concurrent: false
    triggers:
     - zuul
    builders:
     - npm
     - cover-publish:
        src: 'coverage'
        dest: 'visualeditor'
    publishers:
     - global-teardown

- job:
    name: 'performance-webpagetest'
    node: contintLabsSlave && UbuntuTrusty
    defaults: global
    logrotate:
        daysToKeep: 60
    concurrent: false
    scm:
      - git:
          url: 'https://gerrit.wikimedia.org/r/p/performance/WebPageTest.git'
          branches:
            - master
          wipe-workspace: true
    triggers:
     - timed: 'H */3 * * *'
    builders:
     - shell: |
        #!/bin/sh -e
        # Securely set beforehand: WMF_WPT_KEY, WPT_ORG_WPT_KEY, WPT_USER, WPT_USER_PASSWORD
        export STATSV_ENDPOINT="https://www.wikimedia.org/beacon/statsv"
        export WPT_RUNS="11"
        export WPT_MOBILE_RUNS="7"
        export WPT_ORG_MOBILE_RUNS="3"
        export WPT_ORG_RUNS="11"
        export WMF_WPT_LOCATION="us-east-1"
        npm install --production
        node ./lib/index.js --batch ./scripts/batch/mobile.txt
        node ./lib/index.js --batch ./scripts/batch/desktop.txt
        node ./lib/index.js --batch ./scripts/batch/login-mobile.txt
        node ./lib/index.js --batch ./scripts/batch/login-desktop.txt
        node ./lib/index.js --batch ./scripts/batch/second-view-mobile.txt
        node ./lib/index.js --batch ./scripts/batch/second-view-desktop.txt
        # Run wpt-org last
        node ./lib/index.js --batch ./scripts/batch/mobile-wpt-org.txt
    wrappers:
      - timeout:
          timeout: 150
          fail: true
      - timestamps
      - ansicolor
      # Values from Jenkins credentials store
      # https://integration.wikimedia.org/ci/credential-store/domain/webpagetest/
      - credentials-binding:
          - text:
              credential-id: 'd5ee743e-b2e4-43eb-bc16-0bf11bcdec43'
              variable: WMF_WPT_KEY
          - text:
              credential-id: 'e0131e1d-c45a-468c-b163-439769f21a20'
              variable: WPT_ORG_WPT_KEY
          - text:
              credential-id: 'f9a95f38-76cc-456d-bc8c-2cf126c604c3'
              variable: WPT_USER
          - text:
              credential-id: '867612a5-40cd-4789-9cda-ebfc7da1ef33'
              variable: WPT_USER_PASSWORD

-
 job:
    name: 'fail-archived-repositories'
    node: contintLabsSlave
    defaults: global
    concurrent: false
    triggers:
     - zuul
    builders:
     - shell: "exit 1"

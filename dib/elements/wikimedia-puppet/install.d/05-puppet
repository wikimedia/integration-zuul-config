#!/bin/bash

if [ ${DIB_DEBUG_TRACE:-0} -gt 0 ]; then
    set -x
fi
set -eu
set -o pipefail

PUPPET_DIR=/puppet
git clone /srv/git/operations/puppet.git "$PUPPET_DIR"

echo "Asserting puppet is installed..."
which puppet

# Puppet exit codes are handled manually
set +e
puppet apply --test --verbose --modulepath=$PUPPET_DIR/modules -e "include contint::packages::python"
EXIT_CODE=$?
if [[ "$EXIT_CODE" == "0" || $EXIT_CODE="2" ]]; then
	echo "puppet apply successful. Exit code $EXIT_CODE"
else
	>&2 echo "Puppet run failed. Exit code $EXIT_CODE"
	exit $EXIT_CODE
fi;
set -e

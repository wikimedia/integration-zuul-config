# Configuration for Wikimedia CI

This repository holds the configuration of the Wikimedia Foundation CI stack,
Jenkins jobs, Docker templates, Zuul workflow.

## Jenkins jobs ##

The configuration files are under `/jjb`. They are to be used with a python
script written by the OpenStack Foundation: Jenkins Job Builder.

When you tweak or add jobs, follow the documentation maintained on mediawiki.org:

  https://www.mediawiki.org/wiki/CI/JJB

For more about the Jenkins Job Builder software and how to use it, refer to the upstream documentation:

  http://ci.openstack.org/jenkins-job-builder/

### Example Usage

Generate XML files for Jenkins jobs from YAML files:

    $ jenkins-jobs test config/jjb/ -o output/

Update Jenkins jobs which name starts with "selenium":

    $ jenkins-jobs --conf etc/jenkins_jobs.ini update config/jjb/ selenium*

## Zuul ##

Zuul workflow is defined in `zuul/layout.yaml` and additional logic to inject
parameters to the build is in `zuul/parameter_functions.py`.

## Docker containers ##

The Docker containers are generated by a Wikimedia Foundation software:
`docker-pkg`. It is based on Jinja templates and Debian changelog and build the
containers enforcing dependencies between them.

https://gerrit.wikimedia.org/r/plugins/gitiles/operations/docker-images/docker-pkg

Refer to its documentation for setting it up. Then from `/dockerfiles` run:

    docker-pkg

Note: a container will only be updated if its `changelog` had a version bump.

For production, the patch has to be merged and the containers MUST be build on
the Wikimedia CI master (contint1001 as of July 19 2018).  A convenient Fabric
entry is available to drive the build:

    fab deploy_docker

Once build successfully, the Docker containers are uploaded to the Wikimedia
Docker registry.  The Jenkins slaves will then be able to pull them.

Next step is to then switch the Jenkins jobs to the new containers. That is
done by simply updating all YAML templates in JJB with the new version to use. Then refresh the jobs and watch carefully the behavior of the new container(s).

Example commits:

  3316f7e52569d371037267726c9007aab5e30e29  A new container
  01465760928d77f094440b322968dd2ec4f4302f  Job update


## Running tests

To test the configuration, we use tox and you need at least version 1.9+ ([bug T125705](https://phabricator.wikimedia.org/T125705))
to run the test suite. Running `tox` in the main dir of your local clone runs the tests.

## Whitelist volunteer users

https://www.mediawiki.org/wiki/Continuous_integration/Whitelist
